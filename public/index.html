<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è·¯çº¿è§„åˆ’ç³»ç»Ÿ</title>
    <script src="https://webapi.amap.com/maps?v=2.0&key="your real key"&plugin=AMap.ToolBar,AMap.Scale"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            background-color: #1e1e2e;
            color: white;
        }
        
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        #sidebar {
            width: 400px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 10;

        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .sidebar-content {
            height: 100vh; /* ä¾§è¾¹æ å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
            overflow: hidden; /* éšè—å¤–éƒ¨æ»šåŠ¨æ¡ */
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px ;
            margin-bottom: 20px;
            max-height: none;
            display: flex;
            flex-direction: column;
        }
        .control-panel.markers-panel {
            min-height: 300px; /* æ ‡è®°ç‚¹é¢æ¿éœ€è¦æ›´å¤šå‚ç›´ç©ºé—´ */
            flex: 1; /* å æ®æ›´å¤šå¯ç”¨å‚ç›´ç©ºé—´ */
        }
        
        .control-panel h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .control-panel h3 i {
            margin-right: 8px;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #4a90e2;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
        
        button:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button i {
            margin-right: 5px;
        }
        
        button.primary {
            background: #00b894;
        }
        
        button.primary:hover {
            background: #00a085;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.secondary {
            background: #8e44ad; /* æ–°å»ºæŒ‰é’®é¢œè‰² */
        }
        button.secondary:hover {
            background: #9b59b6;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #e74c3c;
            transition: background 0.3s;
        }
        
        .status-dot.active {
            background: #2ecc71;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .route-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #map-container {
            flex: 1;
            height: 100vh;
            position: relative;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-controls button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            min-width: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 16px;
        }
        
        /* è·¯çº¿åˆ—è¡¨æ ·å¼ */
        .routes-list {
              flex: 0 1 auto; /* ä¸æ‰©å¼ ï¼Œæ ¹æ®å†…å®¹è‡ªé€‚åº” */
            min-height: 150px;
            max-height: 300px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
        }
        #saved-routes {
            flex: 1;
            max-height: 300px; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…æ— é™æ‰©å¼  */
        }
        
        .route-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .route-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .route-item.active {
            background: rgba(255, 255, 255, 0.25);
            border-left: 4px solid #4a90e2;
        }
        
        .route-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .route-meta {
            font-size: 12px;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 200; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
        }

        .modal-content {
            background-color: #2a5298;
            margin: 10% auto; 
            padding: 20px;
            border-radius: 10px;
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a90e2;
            border-radius: 5px;
            background-color: #1e3c72;
            color: white;
            font-size: 16px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        .modal-footer button {
            margin-left: 10px;
        }

        /* é’ˆå¯¹ä¿¡æ¯çª—å£ä¸­æŒ‰é’®çš„æ ·å¼è¦†ç›– */
        .amap-info-content button {
            flex: none;
            min-width: auto;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            #sidebar {
                width: 350px;
            }
        }
        
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 40vh;
            }
            
            #map-container {
                height: 60vh;
            }
        }
        .route-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .route-item:hover .route-actions {
            opacity: 1;
        }

        .route-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            justify-content: center;
            min-width: auto;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        /* è·¯çº¿é¡¹æ‚¬åœæ•ˆæœå¢å¼º */
        .route-item {
            position: relative;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ç©ºçŠ¶æ€æç¤ºæ ·å¼ */
        .empty-state {
            text-align: center;
            opacity: 0.7;
            padding: 30px 20px;
            color: #95a5a6;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
        }
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a90e2;
            border-radius: 5px;
            background-color: #1e3c72;
            color: white;
            font-size: 16px;
        }

        /* å“åº”å¼ç½‘æ ¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .form-group input[type="number"] {
                font-size: 14px;
            }
        }
        /* æ ‡è®°ç‚¹ç›¸å…³æ ·å¼ */
        .marker-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 6px   8px; /* å‡å°‘å†…è¾¹è· */
            margin-bottom: 5px; /* å‡å°‘é—´è· */
            border-left: 3px solid #3498db;
            transition: all 0.2s;
            min-height: auto;
        }

        .marker-item:hover {
            background: rgba(255, 255, 255, 0.15);

        }

        #markers-list {
            width: 100%;
             height: 100%; /* å…³é”®ï¼šå æ®æ•´ä¸ªé¢æ¿é«˜åº¦ */
            max-height: none !important; /* ç§»é™¤æ‰€æœ‰é«˜åº¦é™åˆ¶ */
            min-height: 100%; /* ç¡®ä¿æœ€å°é«˜åº¦ */
            flex: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
        }
        .markers-panel {
            width: 280px; /* è°ƒæ•´ä¸ºè¾ƒçª„çš„å®½åº¦ */
            min-width: 250px;
            max-width: 320px;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            height: 100%; /* å…³é”®ï¼šå æ®æ•´ä¸ªçˆ¶å®¹å™¨é«˜åº¦ */
            min-height: 100%; /* ç¡®ä¿æœ€å°é«˜åº¦ä¹Ÿæ˜¯100% */
            flex: 1; /* å æ®æ›´å¤šç©ºé—´ */
        }
        .markers-panel button {
            flex: 1; /* æŒ‰é’®å¹³å‡åˆ†é…å®½åº¦ */
            min-width: 100px; /* è®¾ç½®åˆç†çš„æœ€å°å®½åº¦ */
            padding: 10px 8px; /* è°ƒæ•´å†…è¾¹è· */
            font-size: 12px; /* ç¨å¾®ç¼©å°å­—ä½“ */
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .markers-panel .btn-group {
            display: flex;
            flex-direction: row; /* ä¿æŒæ°´å¹³æ’åˆ— */
            gap: 8px; /* å‡å°é—´è· */
            margin-bottom: 12px;
        }
        .marker-item > div:first-child {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px; /* å‡å°‘é—´è· */
        }
        .marker-item strong {
            font-size: 12px; /* ç¨å°å­—ä½“ */
            font-weight: 600;
            color: #e2e8f0;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%; /* é™åˆ¶åç§°å®½åº¦ */
        }

        .marker-item span[style*="background"] {
            font-size: 10px !important; /* æ›´å°çš„æ ‡ç­¾ */
            padding: 1px 4px !important; /* æ›´ç´§å‡‘çš„æ ‡ç­¾ */
            border-radius: 2px !important;
        }

        /* é‡è¦ç¨‹åº¦æ ·å¼è°ƒæ•´ */
        .marker-item > div:nth-child(2) {
            font-size: 11px !important;
            color: #94a3b8 !important;
            margin-bottom: 6px !important;
        }

        /* æ“ä½œæŒ‰é’®ç´§å‡‘å¸ƒå±€ */
        .marker-item > div:last-child {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .marker-item button {
            padding: 3px 6px !important;
            font-size: 10px !important;
            border-radius: 3px !important;
            min-width: auto !important;
            flex: 1 !important;
        }

        /* ç©ºçŠ¶æ€æç¤ºä¹Ÿç›¸åº”è°ƒæ•´ */
        #markers-list .empty-state {
            padding: 30px 20px !important;
                text-align: center;
                opacity: 0.7;
                color: #95a5a6;
        }

        #markers-list .empty-state i {
            font-size: 48px !important;
            margin-bottom: 10px !important;
            display:block
        }
        #markers-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
        }
        .markers-panel h3 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .markers-panel h3 i {
            margin-right: 6px;
            font-size: 13px;
        }
        /* æœç´¢é¢æ¿æ ·å¼ */
        .search-panel {
            background: rgba(255, 255, 255, 0.08) !important;
            border-left: 3px solid #4a90e2;
        }

        .search-panel input::placeholder {
            color: #94a3b8;
            opacity: 0.7;
        }

        .search-panel select option {
            background: #1e3c72;
            color: white;
        }

        /* æœç´¢ç»“æœé«˜äº® */
        .route-item.highlight {
            border-left: 4px solid #00b894;
            background: rgba(0, 184, 148, 0.1);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .search-panel {
                margin-bottom: 15px;
            }

            .search-panel .btn-group {
                flex-direction: column;
            }
        }
                /* éšè—é¢æ¿ç›¸å…³æ ·å¼ */
        .markers-panel {
            width: 280px;
            min-width: 250px;
            max-width: 320px;
            flex-shrink: 0;
            height: 100%;
            min-height: 100%;
            flex: 1;
            transition: all 0.3s ease;
            position: relative;
        }

        .markers-panel.hidden {
            width: 0;
            min-width: 0;
            max-width: 0;
            flex: 0;
            overflow: hidden;
        }

        .markers-panel.hidden .markers-panel-content {
            display: none;
        }

        .toggle-btn {
            position: absolute;
            right: 10px;
            top: 5px;
            width: 5px;
            height: 5px;
            border-radius: 30%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .markers-panel.hidden .toggle-btn {
            right: -40px;
            background: rgba(30, 60, 114, 0.9);
        }

        .markers-panel.hidden .toggle-btn i {
            transform: rotate(360deg)!important;
             position: relative; /* å…è®¸ä½¿ç”¨åç§» */
             right: 25px; /* å‘å·¦å¾®è°ƒ1åƒç´  */
             top: 0; /* å‚ç›´ä½ç½®ä¸å˜ */
        }

        .markers-panel-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }

        /* åœ°å›¾å®¹å™¨åœ¨æ ‡è®°é¢æ¿éšè—æ—¶çš„æ‰©å±• */
        #map-container {
            flex: 1;
            height: 100vh;
            position: relative;
            transition: all 0.3s ease;
        }

        .markers-panel.hidden + #map-container {
            margin-left: 0;
        }
    </style>
</head>
<body>
<!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,1);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background: white;
            border-radius: 12px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        ">
            <!-- å…³é—­æŒ‰é’® -->
            <button onclick="hideLogin()" style="
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
            ">Ã—</button>

            <h2 style="
                text-align: center;
                margin-bottom: 30px;
                color: #333;
            ">ç®¡ç†å‘˜ç™»å½•</h2>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="loginError" style="
                background: #ffebee;
                color: #c62828;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 20px;
                display: none;
            "></div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="
                        display: block;
                        margin-bottom: 8px;
                        color: #555;
                        font-weight: 500;
                    ">ç”¨æˆ·å</label>
                    <input
                        type="text"
                        id="modalUsername"
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                        value="admin"
                        style="
                            width: 100%;
                            padding: 12px 15px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 16px;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#667eea'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    >
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="
                        display: block;
                        margin-bottom: 8px;
                        color: #555;
                        font-weight: 500;
                    ">å¯†ç </label>
                    <input
                        type="password"
                        id="modalPassword"
                        placeholder="è¯·è¾“å…¥å¯†ç "
                        value="admin123"
                        style="
                            width: 100%;
                            padding: 12px 15px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 16px;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#667eea'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    >
                </div>

                <button type="submit" id="loginButton" style="
                    width: 100%;
                    padding: 14px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: opacity 0.3s;
                ">ç™»å½•</button>

                <div id="loginLoading" style="
                    text-align: center;
                    margin-top: 15px;
                    color: #666;
                    display: none;
                ">ç™»å½•ä¸­...</div>
            </form>

            <div style="
                margin-top: 20px;
                padding: 15px;
                background: #f5f7fa;
                border-radius: 8px;
                font-size: 13px;
                color: #666;
            ">
                <div style="font-weight: 600; margin-bottom: 5px;">é»˜è®¤è´¦å·</div>
                <div>ç”¨æˆ·å: admin</div>
                <div>å¯†ç : admin123</div>
            </div>
        </div>
    </div>
        <!-- å·²ç™»å½•çŠ¶æ€æ¡ -->
    <div id="loginStatus" style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.95);
        border-radius: 8px;
        padding: 10px 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        backdrop-filter: blur(10px);
    ">
        <span style="color: #4CAF50;">âœ… å·²ç™»å½•</span>
        <button onclick="logout()" style="
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        ">é€€å‡º</button>
    </div>
    <div id="container">
        <div id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-route"></i> æ™ºèƒ½è·¯çº¿è§„åˆ’ç³»ç»Ÿ</h1>
                <p>åŸºäºé«˜å¾·åœ°å›¾çš„è·¯çº¿è§„åˆ’å¹³å°</p>
            </div>
            
            <div class="sidebar-content">
                <div class="control-panel">
                    <h3><i class="fas fa-draw-polygon"></i> è·¯çº¿æ“ä½œ</h3>
                    <div class="btn-group">
                        <button id="new-route" onclick="startNewRoute()" class="secondary">
                            <i class="fas fa-plus-circle"></i> æ–°å»ºè·¯çº¿
                        </button>
                        <button id="start-drawing" class="primary">
                            <i class="fas fa-pencil-alt"></i> åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼
                        </button>
                    </div>

                    <div class="btn-group">
                         <button id="plan-route" disabled style="background: #4a90e2;">
                            <i class="fas fa-map-marked-alt"></i> è§„åˆ’è·¯å¾„
                        </button>
                    </div>
                    
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span id="status-text">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼</span>
                    </div>
                    
                    <div class="btn-group">
                        <button id="save-route" disabled onclick="openSaveRouteModal()">
                            <i class="fas fa-save"></i> ä¿å­˜è·¯çº¿
                        </button>
                        <button id="load-routes">
                            <i class="fas fa-list"></i> åŠ è½½è·¯çº¿
                        </button>
                        <button id="clear-route" class="danger">
                            <i class="fas fa-trash"></i> æ¸…ç©ºåœ°å›¾ç‚¹
                        </button>
                    </div>
                </div>
                
                <div class="route-info">
                    <h3><i class="fas fa-info-circle"></i> è·¯çº¿ä¿¡æ¯</h3>
                    <div class="info-item">
                        <span>è·¯å¾„ç‚¹æ•°é‡:</span>
                        <span id="point-count">0</span>
                    </div>
                    <div class="info-item">
                        <span>æ€»è·ç¦»:</span>
                        <span id="total-distance">0 km</span>
                    </div>
                    <div class="info-item">
                        <span>é¢„è®¡æ—¶é—´:</span>
                        <span id="total-time">0 åˆ†é’Ÿ</span>
                    </div>
                    <div class="info-item">
                        <span>è·¯çº¿ç±»å‹:</span>
                        <span id="route-type">æœªè®¾ç½®</span>
                    </div>
                </div>
                
                <div class="routes-list">
                    <h3><i class="fas fa-history"></i> å·²ä¿å­˜è·¯çº¿</h3>
                    <div id="saved-routes">
                        <div style="text-align: center; opacity: 0.7; padding: 20px;">
                            <i class="fas fa-info-circle"></i> æš‚æ— ä¿å­˜çš„è·¯çº¿
                        </div>
                    </div>
                </div>
                <div class="control-panel search-panel">
                    <h3><i class="fas fa-search"></i> è·¯çº¿æœç´¢</h3>
                    <input type="text" id="search-keyword" placeholder="è¾“å…¥å…³é”®è¯..." style="width:100%;padding:8px;margin-bottom:10px;">
                    <button onclick="performSearch()" style="width:100%;padding:10px;">æœç´¢</button>
                </div>
            </div>
        </div>
        <div class="control-panel markers-panel">
    <h3 style="position: relative; padding-right: 40px;">
        <i class="fas fa-map-marker-alt"></i> é‡è¦æ ‡è®°ç‚¹
        <button id="toggle-markers-panel" class="toggle-btn" onclick="toggleMarkersPanel()" title="éšè—é¢æ¿">
            <i class="fas fa-chevron-left"></i>
        </button>
    </h3>
        <div class="markers-panel-content">
            <div class="btn-group">
                <button id="add-marker-mode" onclick="toggleMarkerMode()">
                    <i class="fas fa-plus-circle"></i> æ·»åŠ æ ‡è®°ç‚¹
                </button>
                <button id="view-markers" onclick="loadRouteMarkers()" disabled>
                    <i class="fas fa-eye"></i> æŸ¥çœ‹æ ‡è®°ç‚¹
                </button>
            </div>
            <div id="markers-list">
                <!-- æ ‡è®°ç‚¹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
        <div id="map-container">
            <div class="map-controls">
                <button id="zoom-in" title="æ”¾å¤§">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="zoom-out" title="ç¼©å°">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="reset-view" title="é‡ç½®è§†å›¾">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="point-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="point-modal-title"><i class="fas fa-map-marker-alt"></i> ç¼–è¾‘è·¯å¾„ç‚¹è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal('point-detail-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="point-name">åç§° (å¿…å¡«)</label>
                    <input type="text" id="point-name" placeholder="å¦‚ï¼šXXåŠ æ²¹ç«™">
                </div>
                <div class="form-group">
                    <label for="point-type-select">ç±»å‹</label>
                    <select id="point-type-select"></select>
                </div>
                <div class="form-group">
                    <label for="point-description">è¯¦ç»†æè¿°</label>
                    <textarea id="point-description" rows="3" placeholder="è¾“å…¥è¯¦ç»†æè¿°æˆ–ç‰¹æ®Šæ³¨æ„äº‹é¡¹..."></textarea>
                </div>
                 <div class="form-group">
                    <label for="point-contact">è”ç³»äºº/ç”µè¯</label>
                    <input type="text" id="point-contact" placeholder="å¯é€‰">
                </div>
                <input type="hidden" id="point-image-url"> 
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('point-detail-modal')" class="danger">å–æ¶ˆ</button>
                <button onclick="savePointDetails()" class="primary">ä¿å­˜è¯¦æƒ…</button>
            </div>
        </div>
    </div>

    <div id="save-route-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-save"></i> ä¿å­˜è·¯çº¿</h2>
                <span class="close" onclick="closeModal('save-route-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-group">
                    <label for="route-save-name">è·¯çº¿åç§° (è‹±æ–‡ä¸‹åˆ’çº¿æ•°å­—)</label>
                    <input type="text" id="route-save-name" placeholder="å¦‚ï¼šroute_001"
                           pattern="[a-zA-Z0-9_]+" title="åªèƒ½åŒ…å«è‹±æ–‡ã€ä¸‹åˆ’çº¿å’Œæ•°å­—">
                </div>
                <div class="form-group">
                    <label for="route-save-description">è·¯çº¿è¯´æ˜</label>
                    <textarea id="route-save-description" rows="2" placeholder="è¾“å…¥è·¯çº¿æè¿°..."></textarea>
                </div>
                <div class="form-group">
                    <label for="route-save-type">è·¯çº¿ç±»å‹</label>
                    <select id="route-save-type">
                        <option value="åŸå¸‚è·¯çº¿">åŸå¸‚è·¯çº¿</option>
                        <option value="ä¹¡æ‘è·¯çº¿">ä¹¡æ‘è·¯çº¿</option>
                        <option value="ç‰©æµå¹²çº¿">ç‰©æµå¹²çº¿</option>
                        <option value="å±±è·¯">å±±è·¯</option>
                    </select>
                </div>

                <!-- æ–°å¢ï¼šåœ°ç†ä½ç½®ä¿¡æ¯ -->
                <div class="form-group">
                    <label for="route-save-city">åŸå¸‚</label>
                    <input type="text" id="route-save-city" placeholder="å¦‚ï¼šåŒ—äº¬å¸‚">
                </div>
                <div class="form-group">
                    <label for="route-save-district">è¡Œæ”¿åŒº</label>
                    <input type="text" id="route-save-district" placeholder="å¦‚ï¼šæœé˜³åŒº">
                </div>
                <div class="form-group">
                    <label for="route-save-district-type">è¡Œæ”¿åŒºç±»å‹</label>
                    <select id="route-save-district-type">
                        <option value="åŒº">åŒº</option>
                        <option value="å¿">å¿</option>
                        <option value="å¸‚">å¸‚</option>
                        <option value="è¡—é“">è¡—é“</option>
                    </select>
                </div>

                <!-- æ–°å¢ï¼šè·¯çº¿ç»Ÿè®¡ä¿¡æ¯ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label for="route-save-intersections">ç›´è¡Œè·¯å£</label>
                        <input type="number" id="route-save-intersections" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="route-save-right-turns">å³è½¬</label>
                        <input type="number" id="route-save-right-turns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="route-save-left-turns">å·¦è½¬</label>
                        <input type="number" id="route-save-left-turns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="route-save-u-turns">æ‰å¤´</label>
                        <input type="number" id="route-save-u-turns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="route-save-roundabouts">ç¯å²›</label>
                        <input type="number" id="route-save-roundabouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="route-save-special-lights">ç‰¹æ®Šçº¢ç»¿ç¯</label>
                        <input type="number" id="route-save-special-lights" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="route-save-special-intersections">ç‰¹æ®Šè·¯å£</label>
                    <input type="number" id="route-save-special-intersections" min="0" value="0">
                </div>

                <div class="form-group">
                    <label for="route-save-creator">åˆ›å»ºäºº</label>
                    <input type="text" id="route-save-creator" value="è·¯çº¿è§„åˆ’å‘˜">
                </div>

                <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                    æ€»è·ç¦»: <span id="modal-distance">0 km</span> / é¢„è®¡æ—¶é—´: <span id="modal-time">0 åˆ†é’Ÿ</span>
                </p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('save-route-modal')" class="danger">å–æ¶ˆ</button>
                <button onclick="performSaveRoute()" class="primary">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>
    <!-- æ ‡è®°ç‚¹ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="marker-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="marker-modal-title"><i class="fas fa-map-marker-alt"></i> é‡è¦æ ‡è®°ç‚¹</h2>
                <span class="close" onclick="closeModal('marker-edit-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="marker-name">æ ‡è®°ç‚¹åç§° *</label>
                    <input type="text" id="marker-name" placeholder="è¾“å…¥æ ‡è®°ç‚¹åç§°">
                </div>

                <div class="form-group">
                    <label for="marker-type">æ ‡è®°ç±»å‹</label>
                    <select id="marker-type">
                        <option value="important">é‡è¦æ ‡è®°</option>
                        <option value="gas_station">æ”¶è´¹ç«™ETC</option>
                        <option value="rest_area">æœåŠ¡åŒº</option>
                        <option value="viewpoint">ç‰¹æ®Šçº¢ç»¿ç¯è·¯å£</option>
                        <option value="dangerous">å¤æ‚è·¯å£</option>
                        <option value="construction">æ‹¥å µç‚¹</option>
                        <option value="traffic">ç¯å²›</option>
                        <option value="landmark">æ–½å·¥ç‚¹</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="marker-importance">é‡è¦ç¨‹åº¦</label>
                    <select id="marker-importance">
                        <option value="1">â˜… ä¸€èˆ¬</option>
                        <option value="2">â˜…â˜… é‡è¦</option>
                        <option value="3">â˜…â˜…â˜… å¾ˆé‡è¦</option>
                        <option value="4">â˜…â˜…â˜…â˜… éå¸¸é‡è¦</option>
                        <option value="5">â˜…â˜…â˜…â˜…â˜… å…³é”®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="marker-category">åˆ†ç±»</label>
                    <input type="text" id="marker-category" placeholder="è‡ªå®šä¹‰åˆ†ç±»">
                </div>

                <div class="form-group">
                    <label for="marker-description">è¯¦ç»†æè¿°</label>
                    <textarea id="marker-description" rows="3" placeholder="æè¿°è¿™ä¸ªæ ‡è®°ç‚¹çš„é‡è¦ä¿¡æ¯..."></textarea>
                </div>

                <div class="form-group">
                    <label for="marker-contact">è”ç³»äºº/ç”µè¯</label>
                    <input type="text" id="marker-contact" placeholder="å¯é€‰">
                </div>

                <div class="form-group">
                    <label>ä½ç½®ä¿¡æ¯</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="marker-lng" placeholder="ç»åº¦" step="0.000001">
                        <input type="number" id="marker-lat" placeholder="çº¬åº¦" step="0.000001">
                    </div>
                </div>

                <div class="form-group">
                    <label for="marker-image-upload">ä¸Šä¼ å›¾ç‰‡</label>
                    <input type="file" id="marker-image-upload" accept="image/*">
                    <div id="marker-image-preview" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('marker-edit-modal')" class="danger">å–æ¶ˆ</button>
                <button onclick="saveRouteMarker()" class="primary">ä¿å­˜æ ‡è®°ç‚¹</button>
            </div>
        </div>
    </div>
    <!-- åœ¨ routes-list div ä¸Šæ–¹æ·»åŠ æœç´¢é¢æ¿ -->


        <div class="btn-group">
            <button onclick="performSearch()" class="primary" style="flex: 2;">
                <i class="fas fa-search"></i> æœç´¢
            </button>
            <button onclick="clearSearch()" class="secondary">
                <i class="fas fa-undo"></i> é‡ç½®
            </button>
        </div>

        <div id="search-results-info" style="margin-top: 10px; font-size: 12px; text-align: center; opacity: 0.8;"></div>
    </div>

    <script>
          async function authFetch(url, options = {}) {
              const token = localStorage.getItem('token');

              // âœ… ä¸€å®šè¦ cloneï¼Œä¸èƒ½ç›´æ¥ç”¨åŸå¯¹è±¡
              const headers = {
                ...(options.headers || {})
              };

              const isFormData = options.body instanceof FormData;

              if (token) {
                headers['Authorization'] = 'Bearer ' + token;
              }

              if (isFormData) {
                // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ï¼šFormData å¿…é¡»åˆ æ‰ Content-Type
                delete headers['Content-Type'];
              } else {
                headers['Content-Type'] = 'application/json';
              }

              return fetch(url, {
                ...options,
                headers
              });
            }

        // â­ å…¨å±€å¸¸é‡ï¼šæ ‡è®°çš„ç»Ÿä¸€åç§»é‡ï¼ˆé’ˆå¯¹ 25x34 åƒç´ å›¾æ ‡çš„åº•éƒ¨ä¸­å¿ƒé”šç‚¹ï¼‰
        const MARKER_ANCHOR_OFFSET = new AMap.Pixel(-13, -34); // -13 = -(25/2 + 0.5), -34 = -height

        // å…¨å±€å˜é‡
        let map;
        let currentRoute = {
            id: null,
            points: [],
            polyline: null,
            markers: [],
            distance: 0,
            time: 0,

            // åŸºæœ¬ä¿¡æ¯
            name: "",
            description: "",
            routeType: "åŸå¸‚è·¯çº¿",
            creator: "è·¯çº¿è§„åˆ’å‘˜",
            type: "driving",

            // æ–°å¢å­—æ®µ
            city: "",
            district: "",
            districtType: "åŒº",
            intersections: 0,
            rightTurns: 0,
            leftTurns: 0,
            uTurns: 0,
            roundabouts: 0,
            specialTrafficLights: 0,
            specialIntersections: 0
        };
        
        let isDrawing = false;
        let savedRoutes = [];

        // FUN-003 è·¯å¾„ç‚¹ç¼–è¾‘åŠŸèƒ½æ‰€éœ€å˜é‡
        let editingPointIndex = -1; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„è·¯å¾„ç‚¹ç´¢å¼•
        
        // è·¯å¾„ç‚¹ç±»å‹é…ç½® (FUN-003 æ‰©å……)
        const pointTypes = {
            start: { name: "èµ·ç‚¹", icon: "https://webapi.amap.com/theme/v1.3/markers/n/start.png" },      // ç»¿è‰²
            end: { name: "ç»ˆç‚¹", icon: "https://webapi.amap.com/theme/v1.3/markers/n/end.png" },          // çº¢è‰²
            waypoint: { name: "é€”å¾„ç‚¹", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png" }, // è“è‰²é»˜è®¤
            gas_station: { name: "åŠ æ²¹ç«™", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png" }, // çº¢è‰²æ ‡è®°
            toll_station: { name: "æ”¶è´¹ç«™", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_y.png" }, // é»„è‰²æ ‡è®°
            roundabout: { name: "ç¯å²›", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png" },
            u_turn: { name: "æ‰å¤´", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png" },
            special_cross: { name: "ç‰¹æ®Šè·¯å£", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png" },
            dangerous_section: { name: "å±é™©è·¯æ®µ", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png" },
            rest_area: { name: "ä¼‘æ¯åŒº", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_y.png" }
        };

        // APIåŸºç¡€URL
        const API_BASE = '/api';

        // Helper: æ‰“å¼€æ¨¡æ€æ¡†
        window.openModal = function(id) {
            document.getElementById(id).style.display = 'block';
        };

        // Helper: å…³é—­æ¨¡æ€æ¡†
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        };
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = new AMap.Map('map-container', {
                zoom: 10,
                center: [113.3245904, 23.1066803],
                viewMode: '3D',
                mapStyle: 'amap://styles/normal' 
            });
            
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());
            
            map.on('click', function(e) {
                if (isDrawing) {
                    addRoutePoint(e); 
                }
            });
            
            // åˆå§‹åŒ–ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            populatePointTypeSelect();

            bindButtonEvents();
            
            updateStatus('åœ°å›¾åŠ è½½å®Œæˆï¼Œç‚¹å‡»"åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼"æ·»åŠ è·¯å¾„ç‚¹');
            
            loadRoutes();
        }

        // FUN-003: åˆå§‹åŒ–ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
        function populatePointTypeSelect() {
            const select = document.getElementById('point-type-select');
            select.innerHTML = '';
            for (const key in pointTypes) {
                // æ’é™¤èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œå®ƒä»¬æ˜¯è‡ªåŠ¨è®¾ç½®çš„
                if (key !== 'start' && key !== 'end') { 
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = pointTypes[key].name;
                    select.appendChild(option);
                }
            }
        }
        
        // åˆ‡æ¢ç»˜åˆ¶çŠ¶æ€
        function toggleDrawing() {
            isDrawing = !isDrawing;
            const statusDot = document.querySelector('.status-dot');
            const startBtn = document.getElementById('start-drawing');
            const mapContainer = document.getElementById('map-container'); 
            
            if (isDrawing) {
                statusDot.classList.add('active');
                startBtn.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢ç»˜åˆ¶';
                startBtn.classList.remove('primary');
                startBtn.classList.add('danger');
                
                mapContainer.style.cursor = 'crosshair';
                
                updateStatus('ç»˜åˆ¶æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»åœ°å›¾æ·»åŠ è·¯å¾„ç‚¹');
            } else {
                statusDot.classList.remove('active');
                startBtn.innerHTML = '<i class="fas fa-pencil-alt"></i> åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼';
                startBtn.classList.remove('danger');
                startBtn.classList.add('primary');

                mapContainer.style.cursor = ''; 
                updateStatus('ç»˜åˆ¶æ¨¡å¼å·²åœæ­¢');
            }
        }
        
        // ç»Ÿä¸€æ›´æ–°æ‰€æœ‰ç‚¹çš„ç±»å‹å’Œå›¾æ ‡
        function updateAllPointTypesAndIcons() {
            const total = currentRoute.points.length;
            const planRouteBtn = document.getElementById('plan-route');
            
            currentRoute.points.forEach((point, index) => {
                let actualType = point.userDefinedType || 'waypoint'; // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„ç±»å‹

                // å¼ºåˆ¶å°†ç¬¬ä¸€ä¸ªç‚¹è®¾ä¸ºèµ·ç‚¹ (start)
                if (index === 0 && total > 0) {
                    actualType = 'start';
                } 
                // å¼ºåˆ¶å°†æœ€åä¸€ä¸ªç‚¹è®¾ä¸ºç»ˆç‚¹ (end)
                else if (index === total - 1 && total >= 2) {
                    actualType = 'end';
                }
                
                // ç¡®ä¿æ•°æ®ç»“æ„ä¸­çš„ type åæ˜ å®é™…æ˜¾ç¤ºç±»å‹
                point.type = actualType; 
                
                updateMarkerIcon(point.marker, actualType); 
            });

            // æŒ‰é’®å¯ç”¨é€»è¾‘
            planRouteBtn.disabled = total < 2;
        }
        
        // ä½¿ç”¨ AMap.Icon å®ä¾‹ï¼Œç¡®ä¿å›¾æ ‡è¢«æ­£ç¡®è®¾ç½®å’Œæ¸²æŸ“
        function updateMarkerIcon(marker, type) {
            const iconConfig = pointTypes[type] || pointTypes['waypoint'];

            if (typeof AMap.Icon === 'undefined') {
                return;
            }

            const icon = new AMap.Icon({
                size: new AMap.Size(25, 34),    
                image: iconConfig.icon,         
                imageSize: new AMap.Size(25, 34) 
            });

            marker.setIcon(icon);
        }
        
        // æ·»åŠ è·¯å¾„ç‚¹ (FUN-003 æ•°æ®ç»“æ„æ›´æ–°)
        function addRoutePoint(clickEvent) {
            const lnglat = clickEvent.lnglat;

            // 1. åˆ›å»ºæ ‡è®°
            const marker = new AMap.Marker({
                position: lnglat, 
                icon: pointTypes.waypoint.icon, 
                offset: MARKER_ANCHOR_OFFSET, 
                map: map,
                draggable: true
            });

            const pointIndex = currentRoute.points.length;
            
            // 2. FUN-003ï¼šä¿å­˜ç‚¹ä¿¡æ¯ï¼ŒåŒ…å«è¯¦ç»†å­—æ®µ
            const point = {
                lng: lnglat.lng,
                lat: lnglat.lat,
                type: 'waypoint', // å®é™…æ˜¾ç¤ºç±»å‹ï¼Œç”± updateAllPointTypesAndIcons ä¿®æ­£
                userDefinedType: 'waypoint', // ç”¨æˆ·å¯ç¼–è¾‘çš„ç±»å‹ (é€”å¾„ç‚¹)
                name: `è·¯å¾„ç‚¹ ${pointIndex + 1}`,
                description: "",
                imageURL: "",
                contact: "",
                marker: marker
            };
            
            currentRoute.points.push(point);
            currentRoute.markers.push(marker);

            // 3. ç»‘å®š Marker ç‚¹å‡»äº‹ä»¶ (FUN-003 å¢å¼ºä¿¡æ¯çª—å£)
            marker.on('click', function() {
                const markerIndex = currentRoute.markers.indexOf(marker);
                if (markerIndex !== -1) {
                    showPointInfoWindow(markerIndex, marker.getPosition());
                }
            });
            
            // æ ‡è®°æ‹–æ‹½äº‹ä»¶
            marker.on('dragend', function() {
                const newPosition = marker.getPosition();
                const pointIndex = currentRoute.markers.indexOf(marker);
                if (pointIndex !== -1) {
                    currentRoute.points[pointIndex].lng = newPosition.lng;
                    currentRoute.points[pointIndex].lat = newPosition.lat;
                    
                    clearRouteLine(); 
                    updateUI();
                }
            });
            
            // 4. æ›´æ–°æ‰€æœ‰ç‚¹çš„ç±»å‹å’Œå›¾æ ‡
            updateAllPointTypesAndIcons();

            clearRouteLine(); 
            updateUI();
            
            updateStatus(`å·²æ·»åŠ è·¯å¾„ç‚¹ ${currentRoute.points.length}ï¼Œè¯·ç‚¹å‡»â€œè§„åˆ’è·¯å¾„â€`);
        }

        let currentInfoWindow;
        // FUN-003ï¼šæ˜¾ç¤ºå¢å¼ºçš„ä¿¡æ¯çª—å£
        function showPointInfoWindow(pointIndex, lnglat) {
            const point = currentRoute.points[pointIndex];
            const typeName = pointTypes[point.type] ? pointTypes[point.type].name : 'æœªçŸ¥';
            const userDefinedTypeName = pointTypes[point.userDefinedType] ? pointTypes[point.userDefinedType].name : typeName;

            const content = `
                <div style="padding: 10px; color: #333; max-width: 250px;">
                    <h4 style="margin-bottom: 5px;">${point.name} (${typeName})</h4>
                    <p style="font-size: 12px; margin-bottom: 5px;">ç”¨æˆ·å®šä¹‰ç±»å‹: ${userDefinedTypeName}</p>
                    <p style="font-size: 12px; margin-bottom: 10px;">ç»çº¬åº¦: ${lnglat.lng.toFixed(4)}, ${lnglat.lat.toFixed(4)}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openPointDetailModal(${pointIndex})" style="padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-edit"></i> ç¼–è¾‘è¯¦æƒ…
                        </button>
                        <button onclick="removePoint(${pointIndex})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
            
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }

            currentInfoWindow = new AMap.InfoWindow({
                content: content,
                offset: new AMap.Pixel(0, -30)
            });
            
            currentInfoWindow.open(map, lnglat);
        }

        // FUN-003ï¼šæ‰“å¼€è·¯å¾„ç‚¹è¯¦æƒ…ç¼–è¾‘æ¨¡æ€æ¡†
        window.openPointDetailModal = function(index) {
            const point = currentRoute.points[index];
            if (!point) return;

            // è®¾ç½®å…¨å±€ç´¢å¼•
            editingPointIndex = index;

            // å¡«å……æ¨¡æ€æ¡†æ•°æ®
            document.getElementById('point-modal-title').textContent = `ç¼–è¾‘ ${pointTypes[point.type].name} ${index + 1} è¯¦æƒ…`;
            document.getElementById('point-name').value = point.name;
            document.getElementById('point-description').value = point.description;
            document.getElementById('point-contact').value = point.contact;
            
            const typeSelect = document.getElementById('point-type-select');
            
            // èµ·ç‚¹/ç»ˆç‚¹ä¸èƒ½é€šè¿‡ä¸‹æ‹‰æ¡†ä¿®æ”¹ç±»å‹ï¼Œæ‰€ä»¥ç¦ç”¨ä¸‹æ‹‰æ¡†
            if (point.type === 'start' || point.type === 'end') {
                typeSelect.disabled = true;
                // æš‚æ—¶ç§»é™¤èµ·ç‚¹/ç»ˆç‚¹åœ¨ä¸‹æ‹‰æ¡†ä¸­å­˜åœ¨çš„å¯èƒ½æ€§
                typeSelect.value = point.userDefinedType; 
            } else {
                typeSelect.disabled = false;
                typeSelect.value = point.userDefinedType; 
            }

            // æ‰“å¼€æ¨¡æ€æ¡†
            openModal('point-detail-modal');
        }

        // FUN-003ï¼šä¿å­˜è·¯å¾„ç‚¹è¯¦æƒ…
        window.savePointDetails = function() {
            if (editingPointIndex === -1) return;

            const point = currentRoute.points[editingPointIndex];
            const typeSelect = document.getElementById('point-type-select');

            // æ›´æ–°ç‚¹æ•°æ®
            point.name = document.getElementById('point-name').value || `è·¯å¾„ç‚¹ ${editingPointIndex + 1}`;
            point.description = document.getElementById('point-description').value;
            point.contact = document.getElementById('point-contact').value;
            // FUN-003: æ›´æ–°ç”¨æˆ·å®šä¹‰çš„ç±»å‹ï¼Œå¦‚æœä¸æ˜¯èµ·ç‚¹/ç»ˆç‚¹
            if (point.type !== 'start' && point.type !== 'end') {
                 point.userDefinedType = typeSelect.value;
            }
            // ç¡®ä¿å®é™…æ˜¾ç¤ºçš„å›¾æ ‡æ›´æ–°
            updateAllPointTypesAndIcons(); 

            // å…³é—­æ¨¡æ€æ¡†å’Œä¿¡æ¯çª—å£
            closeModal('point-detail-modal');
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }

            updateStatus(`å·²ä¿å­˜è·¯å¾„ç‚¹ ${editingPointIndex + 1} çš„è¯¦ç»†ä¿¡æ¯ã€‚`);
            editingPointIndex = -1;
        }

        // è®¡ç®—è·¯çº¿ (é€»è¾‘ä¸å˜)
        async function calculateRoute() {
            if (currentRoute.points.length < 2) {
                 updateStatus('è·¯å¾„ç‚¹ä¸è¶³ï¼Œéœ€è¦è‡³å°‘2ä¸ªç‚¹æ¥è§„åˆ’è·¯çº¿', false, true);
                 return;
            }
            
            updateStatus('è®¡ç®—è·¯çº¿ä¸­...', true);
            
            const planRouteBtn = document.getElementById('plan-route');
            const originalPlanText = planRouteBtn.innerHTML;
            planRouteBtn.disabled = true;
            planRouteBtn.innerHTML = '<div class="loading"></div> è®¡ç®—ä¸­...';
            
            const saveBtn = document.getElementById('save-route');
            saveBtn.disabled = true;

            try {
                clearRouteLine();

                const response = await authFetch(API_BASE + '/plan-route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        points: currentRoute.points.map(p => ({ lng: p.lng, lat: p.lat })),
                        strategy: "0"
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentRoute.distance = result.data.distance;
                    currentRoute.time = result.data.time;
                    
                    // æ³¨æ„ï¼šè¿™é‡Œçš„ result.data.polyline æ˜¯é«˜å¾·APIè¿”å›çš„åæ ‡æ•°ç»„ [[lng, lat], ...]
                    drawRouteLine(result.data.polyline || currentRoute.points);
                    
                    updateStatus(`è·¯çº¿è®¡ç®—å®Œæˆï¼Œæ€»è·ç¦» ${currentRoute.distance} km`);
                    
                } else {
                    throw new Error(result.message || 'è·¯çº¿è®¡ç®—å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ è·¯çº¿è®¡ç®—å¤±è´¥:', error.message);
                updateStatus(`è·¯çº¿è®¡ç®—å¤±è´¥: ${error.message}`, false, true);
                clearRouteLine(); 
            } finally {
                planRouteBtn.innerHTML = originalPlanText; 
                planRouteBtn.disabled = currentRoute.points.length < 2; 

                updateUI(); 
            }
        }
        
        // ç»˜åˆ¶è·¯çº¿çº¿ (é€»è¾‘ä¸å˜)
        function drawRouteLine(polylineData) {
            if (currentRoute.polyline) {
                map.remove(currentRoute.polyline);
            }

            let path;
            if (Array.isArray(polylineData[0])) {
                path = polylineData.map(p => new AMap.LngLat(p[0], p[1]));
            } else {
                path = polylineData;
            }

            currentRoute.polyline = new AMap.Polyline({
                path: path,
                strokeColor: "#9400D3" ,
                strokeWeight: 6,
                strokeStyle: "solid",
                lineJoin: 'round',
                map: map
            });

            // ä¿®å¤ï¼šç¡®ä¿åœ°å›¾æ­£ç¡®è·³è½¬åˆ°è·¯çº¿èŒƒå›´
            if (path.length > 0) {
                // ä½¿ç”¨setFitViewç¡®ä¿è·¯çº¿å®Œå…¨æ˜¾ç¤ºåœ¨è§†é‡ä¸­
                map.setFitView([currentRoute.polyline]);
            }
        }
        
        // æ¸…é™¤è·¯çº¿çº¿ (é€»è¾‘ä¸å˜)
        function clearRouteLine() {
            if (currentRoute.polyline) {
                map.remove(currentRoute.polyline);
                currentRoute.polyline = null;
                
                currentRoute.distance = 0;
                currentRoute.time = 0;
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è·¯å¾„ç‚¹å’Œè·¯çº¿ (æ ¸å¿ƒé‡ç½®é€»è¾‘)
        function clearRoute() {
            clearRouteLine(); 
            map.remove(currentRoute.markers); 
            
            currentRoute = {
                id: null, // <--- **ä¿®å¤ç‚¹ï¼šé‡ç½® ID**
                points: [],
                polyline: null,
                markers: [],
                distance: 0,
                time: 0,
                name: "æœªå‘½åè·¯çº¿", 
                routeType: "åŸå¸‚è·¯çº¿", 
                description: "",
                creator: "è·¯çº¿è§„åˆ’å‘˜",
                type: "driving"
            };
            
            updateAllPointTypesAndIcons(); 
            updateUI();
            
            // ç§»é™¤è·¯çº¿åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // æ–°å¢ï¼šå¯åŠ¨æ–°çš„è·¯çº¿è§„åˆ’ (è§£å†³äº¤äº’é—®é¢˜)
        window.startNewRoute = function() {
            clearRoute(); // æ‰§è¡Œæ ¸å¿ƒé‡ç½®
            updateStatus('âœ… å·²æ¸…é™¤ï¼Œå¯ä»¥ç‚¹å‡»â€œåˆ‡æ¢ç»˜åˆ¶æ¨¡å¼â€å¼€å§‹æ–°çš„è·¯çº¿è§„åˆ’ã€‚');
            isDrawing = false; // ç¡®ä¿ç»˜åˆ¶æ¨¡å¼å…³é—­
            toggleDrawing(); // ç¡®ä¿æŒ‰é’®çŠ¶æ€è¢«æ›´æ–°
        }
        
        // ç§»é™¤å•ä¸ªè·¯å¾„ç‚¹ (é€»è¾‘ä¸å˜)
        window.removePoint = function(index) {
            if (index >= 0 && index < currentRoute.points.length) {
                map.remove(currentRoute.markers[index]);
                
                currentRoute.points.splice(index, 1);
                currentRoute.markers.splice(index, 1);
                
                updateAllPointTypesAndIcons();
                
                clearRouteLine();
                updateUI();

                if (currentRoute.points.length >= 2) {
                    updateStatus(`å·²åˆ é™¤è·¯å¾„ç‚¹ã€‚è¿˜å‰© ${currentRoute.points.length} ä¸ªç‚¹ï¼Œè¯·é‡æ–°ç‚¹å‡»â€œè§„åˆ’è·¯å¾„â€`, false, false);
                } else if (currentRoute.points.length === 1) {
                    updateStatus('å·²åˆ é™¤è·¯å¾„ç‚¹ã€‚è¿˜å‰© 1 ä¸ªç‚¹ (ç»ˆç‚¹)ï¼Œè¯·ç»§ç»­æ·»åŠ ', false, false);
                } else {
                     updateStatus('æ‰€æœ‰è·¯å¾„ç‚¹å·²æ¸…é™¤', false, false);
                }

                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
            }
        };
        
        // æ›´æ–°ä¾§è¾¹æ å’ŒæŒ‰é’®çŠ¶æ€ (é€»è¾‘ä¸å˜)
        function updateUI() {
            document.getElementById('point-count').textContent = currentRoute.points.length;
            document.getElementById('total-distance').textContent = `${currentRoute.distance || 0} km`;
            document.getElementById('total-time').textContent = `${currentRoute.time || 0} åˆ†é’Ÿ`;
            document.getElementById('route-type').textContent = currentRoute.routeType || 'æœªè®¾ç½®';
            
            const saveBtn = document.getElementById('save-route');
            const saveBtnText = currentRoute.distance > 0 ? 'ä¿å­˜è·¯çº¿' : 'è®¡ç®—æˆåŠŸåä¿å­˜';
            
            saveBtn.disabled = currentRoute.distance === 0;
            saveBtn.innerHTML = `<i class="fas fa-save"></i> ${saveBtnText}`;
            
            document.getElementById('plan-route').disabled = currentRoute.points.length < 2;
        }
        
        // æ›´æ–°çŠ¶æ€æ  (é€»è¾‘ä¸å˜)
        function updateStatus(message, isLoading = false, isError = false) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            
            if (isLoading) {
                statusDot.style.background = '#f1c40f'; 
                statusDot.classList.remove('active');
            } else if (isError) {
                statusDot.style.background = '#e74c3c'; 
                statusDot.classList.remove('active');
            } else if (isDrawing) {
                statusDot.style.background = '#2ecc71'; 
                statusDot.classList.add('active');
            } else {
                statusDot.style.background = '#95a5a6'; 
                statusDot.classList.remove('active');
            }
        }

        // FUN-004: æ‰“å¼€è·¯çº¿ä¿å­˜æ¨¡æ€æ¡†
        window.openSaveRouteModal = function() {
            if (currentRoute.distance === 0 || currentRoute.points.length < 2) {
                alert('è¯·å…ˆæˆåŠŸè®¡ç®—å‡ºè·¯çº¿åå†ä¿å­˜ã€‚');
                return;
            }
            
            // å¡«å……æ¨¡æ€æ¡†ä¸­çš„è·ç¦»å’Œæ—¶é—´
            document.getElementById('modal-distance').textContent = `${currentRoute.distance || 0} km`;
            document.getElementById('modal-time').textContent = `${currentRoute.time || 0} åˆ†é’Ÿ`;
            
            // é¢„å¡«å……å·²æœ‰çš„å…ƒæ•°æ®
            document.getElementById('route-save-name').value = currentRoute.name || '';
            document.getElementById('route-save-description').value = currentRoute.description || '';
            document.getElementById('route-save-type').value = currentRoute.routeType || 'åŸå¸‚è·¯çº¿';
            document.getElementById('route-save-city').value = currentRoute.city || '';
            document.getElementById('route-save-district').value = currentRoute.district || '';
            document.getElementById('route-save-district-type').value = currentRoute.districtType || 'åŒº';
            document.getElementById('route-save-intersections').value = currentRoute.intersections || 0;
            document.getElementById('route-save-right-turns').value = currentRoute.rightTurns || 0;
            document.getElementById('route-save-left-turns').value = currentRoute.leftTurns || 0;
            document.getElementById('route-save-u-turns').value = currentRoute.uTurns || 0;
            document.getElementById('route-save-roundabouts').value = currentRoute.roundabouts || 0;
            document.getElementById('route-save-special-lights').value = currentRoute.specialTrafficLights || 0;
            document.getElementById('route-save-special-intersections').value = currentRoute.specialIntersections || 0;
            document.getElementById('route-save-creator').value = currentRoute.creator || 'è·¯çº¿è§„åˆ’å‘˜';

            openModal('save-route-modal');
        }

        // FUN-004: æ‰§è¡Œè·¯çº¿ä¿å­˜
        window.performSaveRoute = function() {
            const routeName = document.getElementById('route-save-name').value;
            const routeDescription = document.getElementById('route-save-description').value;
            const routeType = document.getElementById('route-save-type').value;
            const routeCity = document.getElementById('route-save-city').value;
            const routeDistrict = document.getElementById('route-save-district').value;
            const routeDistrictType = document.getElementById('route-save-district-type').value;
            const routeIntersections = parseInt(document.getElementById('route-save-intersections').value) || 0;
            const routeRightTurns = parseInt(document.getElementById('route-save-right-turns').value) || 0;
            const routeLeftTurns = parseInt(document.getElementById('route-save-left-turns').value) || 0;
            const routeUTurns = parseInt(document.getElementById('route-save-u-turns').value) || 0;
            const routeRoundabouts = parseInt(document.getElementById('route-save-roundabouts').value) || 0;
            const routeSpecialLights = parseInt(document.getElementById('route-save-special-lights').value) || 0;
            const routeSpecialIntersections = parseInt(document.getElementById('route-save-special-intersections').value) || 0;
            const routeCreator = document.getElementById('route-save-creator').value;

            if (!routeName) {
                alert('è·¯çº¿åç§°æ˜¯å¿…å¡«é¡¹ï¼');
                return;
            }

            // ç¡®ä¿å­—æ®µæ­£ç¡®è®¾ç½®
            currentRoute.name = routeName;
            currentRoute.description = routeDescription;
            currentRoute.routeType = routeType;
            currentRoute.city = routeCity;
            currentRoute.district = routeDistrict;
            currentRoute.districtType = routeDistrictType;
            currentRoute.intersections = routeIntersections;
            currentRoute.rightTurns = routeRightTurns;
            currentRoute.leftTurns = routeLeftTurns;
            currentRoute.uTurns = routeUTurns;
            currentRoute.roundabouts = routeRoundabouts;
            currentRoute.specialTrafficLights = routeSpecialLights;
            currentRoute.specialIntersections = routeSpecialIntersections;
            currentRoute.creator = routeCreator;

            // è°ƒç”¨ä¿å­˜å‡½æ•°
            saveRoute();

            // å…³é—­æ¨¡æ€æ¡†
            closeModal('save-route-modal');
        };
        
        // FUN-004/FUN-005: å®é™…ä¿å­˜è·¯çº¿åˆ°åç«¯ (æ›´æ–°é€»è¾‘)
        async function saveRoute() {
            const isUpdate = !!currentRoute.id; // åˆ¤æ–­æ˜¯æ›´æ–°è¿˜æ˜¯æ–°å¢
            const method = isUpdate ? 'PUT' : 'POST';
            const url = isUpdate ? `${API_BASE}/routes/${currentRoute.id}` : `${API_BASE}/routes`;

            updateStatus(isUpdate ? 'æ›´æ–°è·¯çº¿ä¸­...' : 'ä¿å­˜æ–°è·¯çº¿ä¸­...', true);

            try {
                const storablePoints = currentRoute.points.map(p => ({
                    lng: p.lng,
                    lat: p.lat,
                    type: p.type,
                    userDefinedType: p.userDefinedType,
                    name: p.name,
                    description: p.description,
                    contact: p.contact,
                    imageURL: p.imageURL
                }));

                const polylinePath = currentRoute.polyline ? currentRoute.polyline.getPath().map(p => `${p.lng},${p.lat}`).join(';') : '';

                const fullRouteData = {
                    name: currentRoute.name,
                    description: currentRoute.description,
                    route_type: currentRoute.routeType,

                    // æ–°å¢å­—æ®µ
                    city: currentRoute.city,
                    district: currentRoute.district,
                    district_type: currentRoute.districtType,
                    intersections: currentRoute.intersections,
                    right_turns: currentRoute.rightTurns,
                    left_turns: currentRoute.leftTurns,
                    u_turns: currentRoute.uTurns,
                    roundabouts: currentRoute.roundabouts,
                    special_traffic_lights: currentRoute.specialTrafficLights,
                    special_intersections: currentRoute.specialIntersections,

                    // åŸæœ‰å­—æ®µ
                    created_by: currentRoute.creator,
                    start_lng: currentRoute.points[0]?.lng || 0,
                    start_lat: currentRoute.points[0]?.lat || 0,
                    end_lng: currentRoute.points[currentRoute.points.length - 1]?.lng || 0,
                    end_lat: currentRoute.points[currentRoute.points.length - 1]?.lat || 0,
                    waypoints: JSON.stringify(storablePoints),
                    distance: parseFloat(currentRoute.distance) || 0,
                    duration: currentRoute.time || 0,
                    polyline: polylinePath,
                    steps: JSON.stringify([])
                };

                const response = await authFetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fullRouteData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'æœªçŸ¥æœåŠ¡å™¨é”™è¯¯' }));
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${errorData.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'}`);
                }

                const result = await response.json();

                if (result.success) {
                    if (!isUpdate) {
                        currentRoute.id = result.data.id;
                    }
                    updateStatus(`è·¯çº¿ '${currentRoute.name}' ${isUpdate ? 'æ›´æ–°' : 'ä¿å­˜'}æˆåŠŸ!`);

                    // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
                    resetSaveModal();

                    loadRoutes();
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }

            } catch (error) {
                console.error('âŒâŒ è·¯çº¿ä¿å­˜/æ›´æ–°å¤±è´¥:', error.message);
                updateStatus(`è·¯çº¿ä¿å­˜/æ›´æ–°å¤±è´¥: ${error.message}`, false, true);
            } finally {
                updateUI();
            }
        }

        // åŠ è½½è·¯çº¿åˆ—è¡¨ (é€»è¾‘ä¸å˜)
        async function loadRoutes() {
            updateStatus('åŠ è½½å·²ä¿å­˜è·¯çº¿...', true);
            const listContainer = document.getElementById('saved-routes');
            listContainer.innerHTML = '';
            
            try {
                const response = await fetch(API_BASE + '/routes');
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    savedRoutes = result.data;
                    savedRoutes.forEach(route => {
                        const item = document.createElement('div');
                        item.className = 'route-item';
                        item.setAttribute('data-id', route.id);
                        item.onclick = () => loadSavedRoute(route.id);
                        item.innerHTML = `
                            <div class="route-name">${route.name}</div>
                            <div class="route-meta">
                                <span><i class="fas fa-route"></i> ${route.distance ? route.distance.toFixed(1) : 0} km</span>
                                <span><i class="fas fa-clock"></i> ${route.duration || 0} min</span>
                                <span><i class="fas fa-tag"></i> ${route.route_type}</span>
                            </div>
                            <div class="route-meta">
                                <span><i class="fas fa-city"></i> ${route.city || 'æœªè®¾ç½®'}</span>
                                <span><i class="fas fa-map-marker"></i> ${route.district || 'æœªè®¾ç½®'}</span>

                            </div>
                            <div class="route-meta">
                                <span><i class="fas fa-calendar"></i> ${new Date(route.created_at).toLocaleDateString()}</span>
                                <span><i class="fas fa-user"></i> ${route.created_by || 'ç³»ç»Ÿ'}</span>
                            </div>
                            <div class="route-actions">
                                <button class="route-action-btn edit-btn" onclick="editRoute(${route.id}, event)">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                </button>
                                <button class="route-action-btn delete-btn" onclick="deleteRoute(${route.id}, event)">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                    updateStatus('å·²æˆåŠŸåŠ è½½è·¯çº¿åˆ—è¡¨');
                } else {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-route"></i>
                            <p>æš‚æ— ä¿å­˜çš„è·¯çº¿</p>
                            <p style="font-size: 12px; margin-top: 10px;">ç‚¹å‡»"æ–°å»ºè·¯çº¿"å¼€å§‹è§„åˆ’</p>
                        </div>
                    `;
                    updateStatus('æš‚æ— ä¿å­˜çš„è·¯çº¿');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è·¯çº¿åˆ—è¡¨å¤±è´¥:', error.message);
                listContainer.innerHTML = `<div style="text-align: center; opacity: 0.7; padding: 20px; color: #e74c3c;"><i class="fas fa-times-circle"></i> åŠ è½½å¤±è´¥: ${error.message}</div>`;
                updateStatus(`åŠ è½½è·¯çº¿åˆ—è¡¨å¤±è´¥: ${error.message}`, false, true);
            }
        }
        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        function bindButtonEvents() {
            document.getElementById('start-drawing').addEventListener('click', toggleDrawing); 
            document.getElementById('clear-route').addEventListener('click', clearRoute); 
            document.getElementById('plan-route').addEventListener('click', calculateRoute); 
            
            document.getElementById('save-route').addEventListener('click', openSaveRouteModal); 
            
            document.getElementById('load-routes').addEventListener('click', loadRoutes);
            
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('reset-view').addEventListener('click', () => {
                map.setZoomAndCenter(10,  [113.3245904, 23.1066803]);
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            if (typeof AMap === 'undefined') {
                alert('âŒ é«˜å¾·åœ°å›¾JS APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyé…ç½®');
                return;
            }
            
            initMap();
        };
        // åˆ é™¤è·¯çº¿
        window.deleteRoute = async function(routeId, event) {
            if (event) event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è·¯çº¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            updateStatus('åˆ é™¤è·¯çº¿ä¸­...', true);

            try {
                const response = await authFetch(`${API_BASE}/routes/${routeId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    updateStatus(`è·¯çº¿åˆ é™¤æˆåŠŸ`);

                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¢«åˆ é™¤çš„è·¯çº¿ï¼Œæ¸…ç©ºå½“å‰è·¯çº¿
                    if (currentRoute.id === routeId) {
                        clearRoute();
                    }

                    // é‡æ–°åŠ è½½è·¯çº¿åˆ—è¡¨
                    loadRoutes();
                } else {
                    throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
                }

            } catch (error) {
                console.error('âŒâŒ åˆ é™¤è·¯çº¿å¤±è´¥:', error);
                updateStatus(`åˆ é™¤å¤±è´¥: ${error.message}`, false, true);
            }
        };

// ç¼–è¾‘è·¯çº¿ - æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        window.editRoute = function(routeId, event) {
            if (event) event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            // æ‰¾åˆ°å¯¹åº”çš„è·¯çº¿æ•°æ®
            const route = savedRoutes.find(r => r.id === routeId);
            if (!route) {
                updateStatus('æœªæ‰¾åˆ°è·¯çº¿æ•°æ®', false, true);
                return;
            }

            // å¡«å……ç¼–è¾‘æ¨¡æ€æ¡†
            // å¡«å……æ‰€æœ‰å­—æ®µ
            document.getElementById('route-save-name').value = route.name;
            document.getElementById('route-save-description').value = route.description || '';
            document.getElementById('route-save-type').value = route.route_type || 'åŸå¸‚è·¯çº¿';
            document.getElementById('route-save-city').value = route.city || '';
            document.getElementById('route-save-district').value = route.district || '';
            document.getElementById('route-save-district-type').value = route.district_type || 'åŒº';
            document.getElementById('route-save-intersections').value = route.intersections || 0;
            document.getElementById('route-save-right-turns').value = route.right_turns || 0;
            document.getElementById('route-save-left-turns').value = route.left_turns || 0;
            document.getElementById('route-save-u-turns').value = route.u_turns || 0;
            document.getElementById('route-save-roundabouts').value = route.roundabouts || 0;
            document.getElementById('route-save-special-lights').value = route.special_traffic_lights || 0;
            document.getElementById('route-save-special-intersections').value = route.special_intersections || 0;
            document.getElementById('route-save-creator').value = route.created_by || 'è·¯çº¿è§„åˆ’å‘˜';

            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜å’ŒæŒ‰é’®
            document.querySelector('#save-route-modal .modal-header h2').innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘è·¯çº¿';
            document.querySelector('#save-route-modal .modal-footer button.primary').textContent = 'ç¡®è®¤æ›´æ–°';

            // è®¾ç½®å½“å‰è·¯çº¿IDç”¨äºæ›´æ–°
            currentRoute.id = routeId;
            currentRoute.name = route.name;
            currentRoute.description = route.description;
            currentRoute.routeType = route.route_type;
            currentRoute.city = route.city;
            currentRoute.district = route.district;
            currentRoute.districtType = route.district_type;
            currentRoute.intersections = route.intersections;
            currentRoute.rightTurns = route.right_turns;
            currentRoute.leftTurns = route.left_turns;
            currentRoute.uTurns = route.u_turns;
            currentRoute.roundabouts = route.roundabouts;
            currentRoute.specialTrafficLights = route.special_traffic_lights;
            currentRoute.specialIntersections = route.special_intersections;
            currentRoute.creator = route.created_by;

            // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
            openModal('save-route-modal');
        };
        function resetSaveModal() {
            document.querySelector('#save-route-modal .modal-header h2').innerHTML = '<i class="fas fa-save"></i> ä¿å­˜è·¯çº¿';
            document.querySelector('#save-route-modal .modal-footer button.primary').textContent = 'ç¡®è®¤ä¿å­˜';
            currentRoute.id = null; // é‡ç½®ID
        }

        // ä¿®æ”¹æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œé‡ç½®çŠ¶æ€
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'save-route-modal') {
                resetSaveModal();
            }
        };

        const markerTypes = {
            important: { name: "é‡è¦æ ‡è®°", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", color: "#E74C3C" },
            gas_station: { name: "æ”¶è´¹ç«™ETC", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", color: "#F39C12" },
            rest_area: { name: "æœåŠ¡åŒº", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", color: "#3498DB" },
            viewpoint: { name: "ç‰¹æ®Šçº¢ç»¿ç¯è·¯å£", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_g.png", color: "#27AE60" },
            dangerous: { name: "å¤æ‚è·¯å†µ", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", color: "#C0392B" },
            construction: { name: "æ‹¥å µç‚¹", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_y.png", color: "#F39C12" },
            traffic: { name: "ç¯å²›", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", color: "#2980B9" },
            landmark: { name: "æ–½å·¥ç‚¹", icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_p.png", color: "#9B59B6" }
        };

        // å…¨å±€å˜é‡
        let isMarkerMode = false;
        let routeMarkers = []; // å½“å‰è·¯çº¿çš„æ ‡è®°ç‚¹
        let currentRouteMarkers = []; // åœ°å›¾ä¸Šæ˜¾ç¤ºçš„æ ‡è®°ç‚¹å¯¹è±¡
        // åˆ‡æ¢æ ‡è®°ç‚¹æ¨¡å¼
        function toggleMarkerMode() {
                    if (!currentRoute.id) {
                alert('è¯·å…ˆä¿å­˜æˆ–åŠ è½½ä¸€æ¡è·¯çº¿');
                return;
            }

            isMarkerMode = !isMarkerMode;
            const btn = document.getElementById('add-marker-mode');
            const mapContainer = document.getElementById('map-container');
            const viewMarkersBtn = document.getElementById('view-markers');

            if (isMarkerMode) {
                btn.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢æ·»åŠ ';
                btn.classList.add('danger');
                mapContainer.style.cursor = 'crosshair';
                viewMarkersBtn.disabled = false; // å¯ç”¨æŸ¥çœ‹æŒ‰é’®
                updateStatus('æ ‡è®°ç‚¹æ¨¡å¼ï¼šç‚¹å‡»åœ°å›¾æ·»åŠ é‡è¦æ ‡è®°ç‚¹');
            } else {
                btn.innerHTML = '<i class="fas fa-plus-circle"></i> æ·»åŠ æ ‡è®°ç‚¹';
                btn.classList.remove('danger');
                mapContainer.style.cursor = '';
                updateStatus('æ ‡è®°ç‚¹æ¨¡å¼å·²å…³é—­');
            }
        }

        // åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆæ·»åŠ æ ‡è®°ç‚¹ï¼‰
        function initMarkerMapEvents() {
            map.on('click', function(e) {
                if (isMarkerMode && currentRoute.id) {
                    addRouteMarker(e.lnglat);
                }
            });
        }

        // æ·»åŠ é‡è¦æ ‡è®°ç‚¹
        async function addRouteMarker(lnglat) {
            if (!currentRoute.id) return;

            // åˆ›å»ºä¸´æ—¶æ ‡è®°
            const marker = new AMap.Marker({
                position: lnglat,
                icon: markerTypes.important.icon,
                offset: MARKER_ANCHOR_OFFSET,
                map: map
            });

            // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
            openMarkerEditModal(null, lnglat, marker);
        }

        // æ‰“å¼€æ ‡è®°ç‚¹ç¼–è¾‘æ¨¡æ€æ¡†
        function openMarkerEditModal(markerData = null, lnglat = null, tempMarker = null) {
            const modal = document.getElementById('marker-edit-modal');
            const title = document.getElementById('marker-modal-title');

            document.getElementById('marker-image-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('marker-image-preview').innerHTML = `
                            <div style="text-align: center;">

                                <div style="margin-top: 5px; font-size: 12px;">${file.name}</div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });

            if (markerData) {
                // ç¼–è¾‘ç°æœ‰æ ‡è®°ç‚¹
                title.textContent = 'ç¼–è¾‘é‡è¦æ ‡è®°ç‚¹';
                populateMarkerForm(markerData);
                if (markerData.image_url) {
                    document.getElementById('marker-image-preview').innerHTML =
                        ``;
                }
            } else {
                // æ·»åŠ æ–°æ ‡è®°ç‚¹
                title.textContent = 'æ·»åŠ é‡è¦æ ‡è®°ç‚¹';
                resetMarkerForm();
                if (lnglat) {
                    document.getElementById('marker-lng').value = lnglat.lng.toFixed(6);
                    document.getElementById('marker-lat').value = lnglat.lat.toFixed(6);
                }
            }

            // ä¿å­˜ä¸´æ—¶æ ‡è®°å¼•ç”¨
            window.currentTempMarker = tempMarker;
            window.currentEditingMarker = markerData;
            window.currentMarkerLnglat = lnglat;

            modal.style.display = 'block';
        }

        // ä¿å­˜æ ‡è®°ç‚¹
        async function saveRouteMarker() {
          const formData = {
            name: document.getElementById('marker-name').value.trim(),
            marker_type: document.getElementById('marker-type').value,
            description: document.getElementById('marker-description').value.trim(),
            contact: document.getElementById('marker-contact').value.trim(),
            importance: parseInt(document.getElementById('marker-importance').value, 10),
            category: document.getElementById('marker-category').value,
            lng: parseFloat(document.getElementById('marker-lng').value),
            lat: parseFloat(document.getElementById('marker-lat').value)
          };

          // åŸºç¡€æ ¡éªŒ
          if (
            !formData.name ||
            Number.isNaN(formData.lng) ||
            Number.isNaN(formData.lat)
          ) {
            alert('è¯·å¡«å†™æ ‡è®°ç‚¹åç§°å’Œæ­£ç¡®çš„ç»çº¬åº¦');
            return;
          }

          try {
            /* ================== 1ï¸âƒ£ å›¾ç‰‡ä¸Šä¼ ï¼ˆç»•è¿‡ authFetchï¼‰ ================== */
            const imageFile = document.getElementById('marker-image-upload').files[0];

            if (imageFile) {
              const uploadFormData = new FormData();
              uploadFormData.append('image', imageFile);

              const token = localStorage.getItem('token');

              const uploadResponse = await fetch('/api/upload-image', {
                method: 'POST',
                headers: {
                  Authorization: 'Bearer ' + token
                  // âŒ ä¸è¦ Content-Type
                },
                body: uploadFormData
              });

              const uploadText = await uploadResponse.text();
              console.log('å›¾ç‰‡ä¸Šä¼ åŸå§‹è¿”å›:', uploadText);

              let uploadResult;
              try {
                uploadResult = JSON.parse(uploadText);
              } catch {
                throw new Error('å›¾ç‰‡ä¸Šä¼ æ¥å£è¿”å›é JSON');
              }

              if (!uploadResult.success) {
                throw new Error(uploadResult.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
              }

              formData.image_url = uploadResult.data.imageUrl;
            }

            /* ================== 2ï¸âƒ£ ä¿å­˜æ ‡è®°ç‚¹ï¼ˆJSONï¼Œç”¨ authFetchï¼‰ ================== */
            const saveResponse = await authFetch('/api/route/marker', {
              method: 'POST',
              body: JSON.stringify(formData)
            });

            const saveText = await saveResponse.text();
            console.log('ä¿å­˜æ ‡è®°ç‚¹åŸå§‹è¿”å›:', saveText);

            let saveResult;
            try {
              saveResult = JSON.parse(saveText);
            } catch {
              throw new Error('ä¿å­˜æ ‡è®°ç‚¹æ¥å£è¿”å›é JSON');
            }

            if (!saveResult.success) {
              throw new Error(saveResult.message || 'ä¿å­˜æ ‡è®°ç‚¹å¤±è´¥');
            }

            alert('æ ‡è®°ç‚¹ä¿å­˜æˆåŠŸ');
            closeMarkerModal?.();
            refreshRouteMarkers?.();

          } catch (err) {
            console.error('ä¿å­˜æ ‡è®°ç‚¹å¤±è´¥:', err);
            alert(err.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          }
        }


        // åŠ è½½è·¯çº¿çš„æ ‡è®°ç‚¹
        async function loadRouteMarkers() {
            if (!currentRoute.id) return;

            try {
                const response = await fetch(`/api/routes/${currentRoute.id}/markers`);
                const result = await response.json();

                if (result.success) {
                    routeMarkers = result.data;
                    displayRouteMarkers(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ ‡è®°ç‚¹å¤±è´¥:', error);
            }
        }

        // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ ‡è®°ç‚¹
        // ä¿®æ”¹æ ‡è®°ç‚¹æ˜¾ç¤ºå‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®åˆ©ç”¨ç©ºé—´
        function displayRouteMarkers(markers) {
            // æ¸…é™¤ç°æœ‰æ ‡è®°ç‚¹
            currentRouteMarkers.forEach(marker => map.remove(marker));
            currentRouteMarkers = [];

            // æ˜¾ç¤ºæ ‡è®°ç‚¹åˆ—è¡¨
            const markersList = document.getElementById('markers-list');
            const markersPanel = document.querySelector('.markers-panel');

            markersList.innerHTML = '';

            // æ ¹æ®æ ‡è®°ç‚¹æ•°é‡æ˜¾ç¤º/éšè—åˆ—è¡¨
            if (markers.length === 0) {
                markersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>æš‚æ— æ ‡è®°ç‚¹</p>
                        <p style="font-size: 12px; margin-top: 5px;">ç‚¹å‡»"æ·»åŠ æ ‡è®°ç‚¹"å¼€å§‹æ·»åŠ </p>
                    </div>
                `;
                markersList.style.display = 'block';
                markersPanel.style.minHeight = '150px';
            } else {
                markersList.style.display = 'block';
                markersPanel.style.minHeight = '250px';

                // åˆ›å»ºæ ‡è®°ç‚¹æ¡ç›®
                markers.forEach((marker, index) => {
                    // åœ°å›¾æ ‡è®°åˆ›å»º
                    const amarker = new AMap.Marker({
                        position: [marker.lng, marker.lat],
                        icon: markerTypes[marker.marker_type]?.icon || markerTypes.important.icon,
                        offset: MARKER_ANCHOR_OFFSET,
                        map: map
                    });

                    amarker.on('click', () => {
                        showMarkerInfoWindow(marker, amarker.getPosition());
                    });

                    currentRouteMarkers.push(amarker);

                    // åˆ›å»ºæ ‡è®°ç‚¹æ¡ç›®
                    const markerItem = document.createElement('div');
                    markerItem.className = 'marker-item';
                    markerItem.style.cursor = 'pointer'; // æ·»åŠ æ‰‹å‹å…‰æ ‡

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - åœ°å›¾ä¸­å¿ƒç§»åŠ¨å¹¶æ”¾å¤§åˆ°æ ‡è®°ç‚¹
                    markerItem.addEventListener('click', function(e) {
                        // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°æŒ‰é’®
                        if (e.target.tagName === 'BUTTON') return;

                        // ç§»åŠ¨åˆ°æ ‡è®°ç‚¹ä½ç½®
                        map.setCenter([marker.lng, marker.lat]);
                        // æ”¾å¤§åˆ°15çº§ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
                        map.setZoom(30);

                        // å¯é€‰ï¼šæ·»åŠ ä¸€ä¸ªåŠ¨ç”»æ•ˆæœï¼Œé«˜äº®æ˜¾ç¤ºè¢«ç‚¹å‡»çš„æ¡ç›®
                        document.querySelectorAll('.marker-item').forEach(item => {
                            item.style.background = 'rgba(255, 255, 255, 0.1)';
                            item.style.borderLeft = '3px solid #3498db';
                        });
                        this.style.background = 'rgba(74, 144, 226, 0.3)';
                        this.style.borderLeft = '3px solid #4a90e2';

                        // å¯é€‰ï¼šè‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
                        showMarkerInfoWindow(marker, [marker.lng, marker.lat]);
                    });

                    markerItem.innerHTML = `
                        <div>
                            <strong>${marker.name}</strong>
                            <span style="background: #666; color: white; padding: 1px 4px; border-radius: 2px; font-size: 10px; margin-left: 5px;">
                                ${markerTypes[marker.marker_type]?.name || 'æ ‡è®°'}
                            </span>
                        </div>
                        <div style="font-size: 11px; color: #94a3b8; margin: 2px 0;">
                            é‡è¦ç¨‹åº¦: ${'â˜…'.repeat(marker.importance || 1)}
                        </div>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <button onclick="event.stopPropagation(); editMarker(${marker.id})"
                                    style="padding: 2px 6px; font-size: 11px; background: #3498db; color: white; border: none; border-radius: 2px; cursor: pointer; flex: 1;">
                                ç¼–è¾‘
                            </button>
                            <button onclick="event.stopPropagation(); deleteMarker(${marker.id})"
                                    style="padding: 2px 6px; font-size: 11px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; flex: 1;">
                                åˆ é™¤
                            </button>
                        </div>
                    `;

                    markersList.appendChild(markerItem);
                });
            }

            // ç¡®ä¿æ ‡è®°ç‚¹é¢æ¿å¯è§
            markersPanel.style.display = 'block';
        }


        // å¡«å……æ ‡è®°ç‚¹è¡¨å•
        function populateMarkerForm(markerData) {
            document.getElementById('marker-name').value = markerData.name || '';
            document.getElementById('marker-type').value = markerData.marker_type || 'important';
            document.getElementById('marker-importance').value = markerData.importance || 1;
            document.getElementById('marker-category').value = markerData.category || '';
            document.getElementById('marker-description').value = markerData.description || '';
            document.getElementById('marker-contact').value = markerData.contact || '';
            document.getElementById('marker-lng').value = markerData.lng || '';
            document.getElementById('marker-lat').value = markerData.lat || '';
        }

        // é‡ç½®æ ‡è®°ç‚¹è¡¨å•
        function resetMarkerForm() {
            document.getElementById('marker-name').value = '';
            document.getElementById('marker-type').value = 'important';
            document.getElementById('marker-importance').value = 1;
            document.getElementById('marker-category').value = '';
            document.getElementById('marker-description').value = '';
            document.getElementById('marker-contact').value = '';
            document.getElementById('marker-lng').value = '';
            document.getElementById('marker-lat').value = '';
        }

        // æ˜¾ç¤ºæ ‡è®°ç‚¹ä¿¡æ¯çª—å£
        function showMarkerInfoWindow(marker, position) {
            const imageContent = marker.image_url ?
            `<div style="margin: 10px 0;">

            </div>` : '';
            const content = `
                <div style="padding: 10px; color: #333; max-width: 250px;">
                    <h4 style="margin-bottom: 5px;">${marker.name}</h4>
                    <p style="font-size: 12px; margin-bottom: 5px;">ç±»å‹: ${markerTypes[marker.marker_type]?.name || 'æ ‡è®°'}</p>
                    <p style="font-size: 12px; margin-bottom: 10px;">é‡è¦ç¨‹åº¦: ${'â˜…'.repeat(marker.importance)}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="editMarker(${marker.id})" style="padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button onclick="deleteMarker(${marker.id})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `;

            if (currentInfoWindow) {
                currentInfoWindow.close();
            }

            currentInfoWindow = new AMap.InfoWindow({
                content: content,
                offset: new AMap.Pixel(0, -30)
            });

            currentInfoWindow.open(map, position);
        }

        // ç¼–è¾‘æ ‡è®°ç‚¹
        window.editMarker = async function(markerId) {
            try {
                // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½äº†æ ‡è®°ç‚¹åˆ—è¡¨
                if (!routeMarkers || routeMarkers.length === 0) {
                    // å¦‚æœæ²¡æœ‰åŠ è½½ï¼Œå…ˆåŠ è½½æ ‡è®°ç‚¹åˆ—è¡¨
                    await loadRouteMarkers();
                }

                // ä»å·²åŠ è½½çš„æ ‡è®°ç‚¹åˆ—è¡¨ä¸­æŸ¥æ‰¾
                const marker = routeMarkers.find(m => m.id === parseInt(markerId));

                if (marker) {
                    openMarkerEditModal(marker);
                } else {
                    throw new Error('æœªæ‰¾åˆ°æ ‡è®°ç‚¹æ•°æ®');
                }
            } catch (error) {
                console.error('è·å–æ ‡è®°ç‚¹è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–æ ‡è®°ç‚¹è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        };

        // åˆ é™¤æ ‡è®°ç‚¹
        window.deleteMarker = async function(markerId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡è®°ç‚¹å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await authFetch(`/api/markers/${markerId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    await loadRouteMarkers();
                    updateStatus('æ ‡è®°ç‚¹åˆ é™¤æˆåŠŸ');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤æ ‡è®°ç‚¹å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        };

        // ä¿®æ”¹åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼Œæ·»åŠ æ ‡è®°ç‚¹æ¨¡å¼æ”¯æŒ
        function initMapWithMarkerSupport() {
            map = new AMap.Map('map-container', {
                zoom: 10,
                center:[113.3245904, 23.1066803],
                viewMode: '3D',
                mapStyle: 'amap://styles/normal'
            });

            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());

            // ç»Ÿä¸€çš„åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç†
            map.on('click', function(e) {
                if (isDrawing) {
                    addRoutePoint(e);
                } else if (isMarkerMode && currentRoute.id) {
                    addRouteMarker(e.lnglat);
                }
            });

            // åˆå§‹åŒ–ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            populatePointTypeSelect();
            bindButtonEvents();
            updateStatus('åœ°å›¾åŠ è½½å®Œæˆï¼Œç‚¹å‡»"åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼"æ·»åŠ è·¯å¾„ç‚¹');
            loadRoutes();
        }

        // ä¿®æ”¹é¡µé¢åŠ è½½åˆå§‹åŒ–å‡½æ•°
        window.onload = function() {
            if (typeof AMap === 'undefined') {
                alert('âŒâŒ é«˜å¾·åœ°å›¾JS APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyé…ç½®');
                return;
            }

            initMapWithMarkerSupport(); // ä½¿ç”¨æ–°çš„åˆå§‹åŒ–å‡½æ•°
        };

        // ç¡®ä¿"æŸ¥çœ‹æ ‡è®°ç‚¹"æŒ‰é’®åœ¨è·¯çº¿åŠ è½½åå¯ç”¨
       window.loadSavedRoute = async function(id) {
            updateStatus(`åŠ è½½è·¯çº¿ ID: ${id}...`, true);

            // æ ·å¼ï¼šæ›´æ–°è·¯çº¿åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.route-item[data-id="${id}"]`);
            if(activeItem) activeItem.classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/routes/${id}`);
                if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

                const result = await response.json();
                if (!result.success || !result.data) throw new Error(result.message || 'è·å–è·¯çº¿è¯¦æƒ…å¤±è´¥');

                const route = result.data;

                // 1. æ¸…ç©ºå½“å‰ç»˜åˆ¶
                clearRoute();

                // 2. è§£æPolylineä¸ºåæ ‡
                let polylinePath = [];
                if (route.polyline) {
                    polylinePath = route.polyline.split(';').map(p => {
                        const [lng, lat] = p.split(',').map(Number);
                        return new AMap.LngLat(lng, lat);
                    });
                }

                // 3. è§£æå®Œæ•´çš„è·¯å¾„ç‚¹é›†åˆ
                let storablePoints = [];
                try {
                    storablePoints = route.waypoints;
                } catch (e) {
                    console.warn('è§£æå®Œæ•´è·¯å¾„ç‚¹é›†åˆå¤±è´¥:', e);
                }

                // å…¼å®¹æ€§ä¿®å¤ï¼šå¦‚æœç‚¹æ•°ä¸è¶³ï¼Œä½¿ç”¨æ—§çš„èµ·ç»ˆç‚¹å­—æ®µé‡å»º
                if (!storablePoints || storablePoints.length < 2) {
                    if (route.start_lng && route.end_lng) {
                        console.warn('ä½¿ç”¨èµ·ç»ˆç‚¹åæ ‡é‡å»ºè·¯çº¿ç‚¹');
                        storablePoints = [
                            {
                                lng: route.start_lng,
                                lat: route.start_lat,
                                name: 'èµ·ç‚¹',
                                description: '',
                                contact: '',
                                imageURL: '',
                                userDefinedType: 'start'
                            },
                            {
                                lng: route.end_lng,
                                lat: route.end_lat,
                                name: 'ç»ˆç‚¹',
                                description: '',
                                contact: '',
                                imageURL: '',
                                userDefinedType: 'end'
                            }
                        ];
                    }
                }

                if (!storablePoints || storablePoints.length < 2) {
                    throw new Error('è·¯çº¿ç‚¹æ•°æ®ä¸å®Œæ•´');
                }

                // 4. é‡å»º currentRoute ç»“æ„
                currentRoute.id = route.id;
                currentRoute.name = route.name;
                currentRoute.description = route.description || '';
                currentRoute.routeType = route.route_type || 'åŸå¸‚è·¯çº¿';
                currentRoute.creator = route.created_by || '';
                currentRoute.type = 'driving';
                currentRoute.distance = route.distance.toFixed(1);
                currentRoute.time = route.duration;

                // 5. é‡æ–°æ·»åŠ æ ‡è®°
                storablePoints.forEach((p, index) => {
                    const lnglat = new AMap.LngLat(p.lng, p.lat);
                    const marker = new AMap.Marker({
                        position: lnglat,
                        icon: pointTypes.waypoint.icon,
                        offset: MARKER_ANCHOR_OFFSET,
                        map: map,
                        draggable: true
                    });

                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    marker.on('click', function() {
                        showPointInfoWindow(index, marker.getPosition());
                    });

                    // æ ‡è®°æ‹–æ‹½äº‹ä»¶
                    marker.on('dragend', function() {
                        const newPosition = marker.getPosition();
                        const pointIndex = currentRoute.markers.indexOf(marker);
                        if (pointIndex !== -1) {
                            currentRoute.points[pointIndex].lng = newPosition.lng;
                            currentRoute.points[pointIndex].lat = newPosition.lat;

                            clearRouteLine();
                            updateUI();
                        }
                    });

                    // é‡å»ºå®Œæ•´çš„ç‚¹å¯¹è±¡
                    const point = {
                        lng: p.lng,
                        lat: p.lat,
                        type: p.type || 'waypoint',
                        userDefinedType: p.userDefinedType || 'waypoint',
                        name: p.name || `è·¯å¾„ç‚¹ ${index + 1}`,
                        description: p.description || '',
                        contact: p.contact || '',
                        imageURL: p.imageURL || '',
                        marker: marker
                    };
                    currentRoute.points.push(point);
                    currentRoute.markers.push(marker);
                });

                // 6. ç¡®ä¿åŠ è½½çš„ç‚¹å›¾æ ‡æ­£ç¡®
                updateAllPointTypesAndIcons();

                // 7. ç»˜åˆ¶è·¯çº¿
                drawRouteLine(polylinePath);

                // 8. å¯ç”¨æ ‡è®°ç‚¹æŒ‰é’®
                document.getElementById('view-markers').disabled = false;
                document.getElementById('add-marker-mode').disabled = false;

                // 9. æ›´æ–° UI å’ŒçŠ¶æ€
                updateUI();
                updateStatus(`å·²åŠ è½½è·¯çº¿: ${route.name}`);

                // 10. è‡ªåŠ¨åŠ è½½è¯¥è·¯çº¿çš„æ ‡è®°ç‚¹
                await loadRouteMarkers();

            } catch (error) {
                console.error('âŒâŒ åŠ è½½ä¿å­˜è·¯çº¿å¤±è´¥:', error.message);
                updateStatus(`åŠ è½½è·¯çº¿å¤±è´¥: ${error.message}`, false, true);
            }
        }

        // ä¿®æ”¹"æŸ¥çœ‹æ ‡è®°ç‚¹"æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('view-markers').addEventListener('click', function() {
            if (currentRoute.id) {
                loadRouteMarkers();
            } else {
                alert('è¯·å…ˆåŠ è½½ä¸€æ¡è·¯çº¿');
            }
        });

        // ä¿®æ”¹æ ‡è®°ç‚¹ä¿¡æ¯çª—å£ï¼Œæ˜¾ç¤ºå¤§å›¾
        function showMarkerInfoWindow(marker, position) {
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œåœ¨ä¿¡æ¯çª—å£ä¸­æ˜¾ç¤º
            const imageContent = marker.image_url ?
            `<div style="margin: 10px 0; text-align: center;">

                <div style="margin-top: 5px;">
                    <a href="${marker.image_url}" target="_blank"
                       style="font-size: 12px; color: #3498db;">æŸ¥çœ‹åŸå›¾</a>
                </div>
            </div>` : '';

            const content = `
                <div style="padding: 10px; color: #333; max-width: 300px;">
                    <h4 style="margin-bottom: 5px;">${marker.name}</h4>
                    <p style="font-size: 12px; margin-bottom: 5px;">ç±»å‹: ${markerTypes[marker.marker_type]?.name || 'æ ‡è®°'}</p>
                    <p style="font-size: 12px; margin-bottom: 5px;">é‡è¦ç¨‹åº¦: ${'â˜…'.repeat(marker.importance)}</p>
                    ${marker.description ? `<p style="font-size: 12px; margin-bottom: 5px;">æè¿°: ${marker.description}</p>` : ''}
                    ${marker.contact ? `<p style="font-size: 12px; margin-bottom: 10px;">è”ç³»æ–¹å¼: ${marker.contact}</p>` : ''}
                    ${imageContent}
                    <div style="display: flex; gap: 10px;">
                        <button onclick="editMarker(${marker.id})" style="padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button onclick="deleteMarker(${marker.id})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `;

            if (currentInfoWindow) {
                currentInfoWindow.close();
            }

            currentInfoWindow = new AMap.InfoWindow({
                content: content,
                offset: new AMap.Pixel(0, -30)
            });

            currentInfoWindow.open(map, position);
        }
                const additionalStyles = `
            .marker-item {
                transition: all 0.2s ease;
                border-left: 3px solid #3498db;
            }

            .marker-item:hover {
                background: rgba(255, 255, 255, 0.15) !important;
                transform: translateX(3px);
            }

            .marker-item.active {
                background: rgba(74, 144, 226, 0.3) !important;
                border-left: 3px solid #4a90e2;
            }
        `;

        // å°†æ ·å¼æ·»åŠ åˆ°æ–‡æ¡£ä¸­
        const styleSheet = document.createElement("style");
        styleSheet.innerText = additionalStyles;
        document.head.appendChild(styleSheet);
       function closeMarkerModal() {
            // 1. éšè—æ¨¡æ€æ¡†
            const modal = document.getElementById('markerModal');
            if (modal) {
                modal.style.display = 'none';
                // å¯é€‰ï¼šç§»é™¤æ˜¾ç¤ºç±»ï¼ˆå¦‚æœä½¿ç”¨äº†CSSç±»æ§åˆ¶æ˜¾ç¤ºï¼‰
                // modal.classList.remove('show');
            }

            // 2. éšè—æˆ–ç§»é™¤èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const modalBackdrop = document.getElementById('modalBackdrop');
            if (modalBackdrop) {
                modalBackdrop.style.display = 'none';
                // æˆ–è€…ä»DOMä¸­ç§»é™¤ï¼šmodalBackdrop.remove();
            } else {
                // å¦‚æœæ²¡æœ‰ç‰¹å®šé®ç½©å…ƒç´ ï¼Œæ£€æŸ¥bodyæ˜¯å¦æœ‰ç›¸å…³ç±»
                document.body.classList.remove('modal-open');
            }

            // 3. æ¸…ç†å½“å‰é€‰ä¸­çš„æ ‡è®°ç‚¹çŠ¶æ€ï¼ˆé‡è¦ï¼šé¿å…é‡å¤ç»‘å®šç­‰é—®é¢˜ï¼‰
            if (window.currentSelectedMarker) {
                // ç§»é™¤é«˜äº®æ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
                window.currentSelectedMarker.setZIndexOffset(0); // æ¢å¤z-indexåç§»
                // æ¸…é™¤å¼•ç”¨
                window.currentSelectedMarker = null;
            }

            // 4. ç§»é™¤ESCé”®å…³é—­äº‹ä»¶ç›‘å¬ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
            if (window.escKeyHandler) {
                document.removeEventListener('keydown', window.escKeyHandler);
                window.escKeyHandler = null;
            }

            // 5. è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼ˆå¯é€‰ï¼šç”¨äºå…¶ä»–ç»„ä»¶ç›‘å¬æ¨¡æ€æ¡†å…³é—­ï¼‰
            const modalClosedEvent = new CustomEvent('markerModalClosed');
            document.dispatchEvent(modalClosedEvent);

            console.log('æ ‡è®°ç‚¹æ¨¡æ€æ¡†å·²å…³é—­'); // è°ƒè¯•ç”¨ï¼Œå®Œæˆåå¯åˆ é™¤
        }
        // æœç´¢åŠŸèƒ½
let currentSearchResults = [];
let currentSearchParams = {};

    function performSearch() {
      console.log('ğŸ”ğŸ” å¼€å§‹æ‰§è¡Œæœç´¢');

      const keyword =
        document.getElementById('search-keyword')?.value?.trim() || '';

      console.log('ğŸ“ğŸ“ æœç´¢å‚æ•°:', { keyword });

      fetch(`/api/routes/search?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(result => {
          console.log('ğŸ“¦ æœç´¢æ¥å£å®Œæ•´è¿”å›:', result);

          // âœ… 1. å–çœŸæ­£çš„è·¯çº¿æ•°ç»„
          const routes = result.data || [];

          console.log('ğŸ“ŠğŸ“Š æœç´¢åˆ°', routes.length, 'æ¡è·¯çº¿');

          // âœ… 2. è¦†ç›–å½“å‰è·¯çº¿æ•°æ®æºï¼ˆå…³é”®ï¼‰
          window.currentRoutes = routes;

          // âœ… 3. é‡æ–°æ¸²æŸ“è·¯çº¿åˆ—è¡¨ / é¢æ¿
          if (typeof renderRoutes === 'function') {
            renderRoutes(routes);
          } else {
            console.warn('âš ï¸ renderRoutes å‡½æ•°ä¸å­˜åœ¨');
          }
        })
        .catch(err => {
          console.error('âŒ æœç´¢å¤±è´¥:', err);
        });
    }
  function displaySearchResults(routes) {
        const listContainer = document.getElementById('saved-routes');
        if (!listContainer) {
            console.error('âŒâŒ ä¿å­˜è·¯çº¿å®¹å™¨ä¸å­˜åœ¨');
            return;
        }

        listContainer.innerHTML = '';

        if (!routes || routes.length === 0) {
            listContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>æœªæ‰¾åˆ°åŒ¹é…çš„è·¯çº¿</p>
                    <p style="font-size: 12px; margin-top: 10px;">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
                </div>
            `;
            return;
        }

        console.log(`ğŸ“ŠğŸ“Š æ˜¾ç¤º ${routes.length} æ¡æœç´¢ç»“æœ`);

        routes.forEach(route => {
            const item = document.createElement('div');
            item.className = 'route-item';
            item.setAttribute('data-id', route.id);
            item.onclick = () => loadSavedRoute(route.id);

            item.innerHTML = `
                <div class="route-name">${route.name || 'æœªå‘½åè·¯çº¿'}</div>
                <div class="route-meta">
                    <span><i class="fas fa-route"></i> ${route.distance ? route.distance.toFixed(1) : 0} km</span>
                    <span><i class="fas fa-clock"></i> ${route.duration || 0} min</span>
                    <span><i class="fas fa-tag"></i> ${route.route_type || 'æœªåˆ†ç±»'}</span>
                </div>
                <div class="route-meta">
                    <span><i class="fas fa-city"></i> ${route.city || 'æœªè®¾ç½®'}</span>
                    <span><i class="fas fa-map-marker"></i> ${route.district || 'æœªè®¾ç½®'}</span>

                </div>
                <div class="route-meta">
                    <span><i class="fas fa-calendar"></i> ${route.created_at ? new Date(route.created_at).toLocaleDateString() : 'æœªçŸ¥æ—¥æœŸ'}</span>
                    <span><i class="fas fa-user"></i> ${route.created_by || 'ç³»ç»Ÿ'}</span>
                </div>
                <div class="route-actions">
                    <button class="route-action-btn edit-btn" onclick="event.stopPropagation(); editRoute(${route.id}, event)">
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </button>
                    <button class="route-action-btn delete-btn" onclick="event.stopPropagation(); deleteRoute(${route.id}, event)">
                        <i class="fas fa-trash"></i> åˆ é™¤
                    </button>
                </div>
            `;
            listContainer.appendChild(item);
        });
    }
    function displayNoResults(searchTerm = "") {
        const listContainer = document.getElementById('saved-routes');
        if (!listContainer) {
            console.error('âŒ ä¿å­˜è·¯çº¿å®¹å™¨ä¸å­˜åœ¨');
            return;
        }

        let message, subMessage;

        if (searchTerm === "æœç´¢æ¡ä»¶ä¸ºç©º") {
            message = "æœç´¢æ¡ä»¶ä¸ºç©º";
            subMessage = "è¯·åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©ç­›é€‰æ¡ä»¶";
        } else if (searchTerm === "æœç´¢æ¡ä»¶") {
            message = "æœç´¢å¤±è´¥";
            subMessage = "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•";
        } else {
            message = `æœªæ‰¾åˆ°åŒ…å«"<strong>${searchTerm}</strong>"çš„è·¯çº¿`;
            subMessage = "å°è¯•è°ƒæ•´å…³é”®è¯æˆ–æ¸…é™¤éƒ¨åˆ†ç­›é€‰æ¡ä»¶";
        }

        listContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <p>${message}</p>
                <p style="font-size: 12px; margin-top: 10px;">${subMessage}</p>
                <div style="margin-top: 15px;">
                    <button onclick="loadAllRoutes()" class="primary" style="margin-right: 10px;">
                        <i class="fas fa-list"></i> æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿
                    </button>
                    <button onclick="clearSearchForm()" class="secondary">
                        <i class="fas fa-undo"></i> æ¸…ç©ºæœç´¢
                    </button>
                </div>
            </div>
        `;
    }
    function loadAllRoutes() {
        console.log('ğŸ“‹ æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿');
        loadRoutes();
        updateStatus('æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿');
    }

// æ¸…ç©ºæœç´¢è¡¨å•
    function clearSearchForm() {
        console.log('ğŸ§¹ æ¸…ç©ºæœç´¢è¡¨å•');

        // æ¸…ç©ºæ‰€æœ‰æœç´¢å­—æ®µ


        if (searchInput) searchInput.value = '';
        if (searchCity) searchCity.value = '';
        if (searchDistrict) searchDistrict.value = '';
        if (searchType) searchType.value = '';
        if (searchCreator) searchCreator.value = '';

        // æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿
        loadAllRoutes();
        updateStatus('å·²æ¸…ç©ºæœç´¢æ¡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰è·¯çº¿');
    }
    // ä¿®æ”¹ç°æœ‰çš„ loadRoutes å‡½æ•°ï¼Œåœ¨éæœç´¢çŠ¶æ€ä¸‹æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿
    async function loadRoutes() {
        // å¦‚æœæœ‰æ´»è·ƒçš„æœç´¢ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœ
        if (Object.values(currentSearchParams).some(param => param)) {
            performSearch();
            return;
        }

        updateStatus('åŠ è½½å·²ä¿å­˜è·¯çº¿...', true);
        const listContainer = document.getElementById('saved-routes');
        listContainer.innerHTML = '';

        try {
            const response = await fetch(API_BASE + '/routes?limit=50');
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                savedRoutes = result.data;
                displaySearchResults(result.data); // ä½¿ç”¨ç›¸åŒçš„æ˜¾ç¤ºå‡½æ•°
                updateStatus('å·²æˆåŠŸåŠ è½½è·¯çº¿åˆ—è¡¨');
            } else {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-route"></i>
                        <p>æš‚æ— ä¿å­˜çš„è·¯çº¿</p>
                        <p style="font-size: 12px; margin-top: 10px;">ç‚¹å‡»"æ–°å»ºè·¯çº¿"å¼€å§‹è§„åˆ’</p>
                    </div>
                `;
                updateStatus('æš‚æ— ä¿å­˜çš„è·¯çº¿');
            }
        } catch (error) {
            console.error('âŒâŒ åŠ è½½è·¯çº¿åˆ—è¡¨å¤±è´¥:', error.message);
            listContainer.innerHTML = `<div style="text-align: center; opacity: 0.7; padding: 20px; color: #e74c3c;"><i class="fas fa-times-circle"></i> åŠ è½½å¤±è´¥: ${error.message}</div>`;
            updateStatus(`åŠ è½½è·¯çº¿åˆ—è¡¨å¤±è´¥: ${error.message}`, false, true);
        }
    }

    // æ·»åŠ æœç´¢æ¡†çš„é”®ç›˜äº‹ä»¶æ”¯æŒ
    // æ›¿æ¢ç°æœ‰çš„æœç´¢æŒ‰é’®äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');

        // è·å–DOMå…ƒç´ 
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');

        if (searchInput) {
            console.log('ğŸ“‹ è¾“å…¥æ¡†åˆå§‹å€¼:', `"${searchInput.value}"`);

            // å¦‚æœæœ‰å€¼ï¼Œè‡ªåŠ¨æœç´¢
            if (searchInput.value.trim() !== '') {
                console.log('ğŸ¯ æ£€æµ‹åˆ°å·²æœ‰è¾“å…¥ï¼Œè‡ªåŠ¨æœç´¢');
                performSearch();
            } else {
                // æ²¡æœ‰å€¼ï¼Œæ˜¾ç¤ºæ‰€æœ‰è·¯çº¿
                console.log('ğŸ“‹ æ˜¾ç¤ºæ‰€æœ‰è·¯çº¿');
                loadRoutes();
            }
        }

        // ç»‘å®šæœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (searchButton && searchInput) {
            searchButton.addEventListener('click', function(e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º

                console.log('ğŸ”˜ æœç´¢æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè¾“å…¥æ¡†å½“å‰å€¼:', `"${searchInput.value}"`);

                // åªåœ¨è¾“å…¥æ¡†æœ‰å€¼æ—¶æ‰§è¡Œæœç´¢
                if (searchInput.value.trim() === '') {
                    console.log('âš ï¸ è¾“å…¥æ¡†ä¸ºç©ºï¼Œä¸æ‰§è¡Œæœç´¢');
                    displayNoResults("æœç´¢æ¡ä»¶ä¸ºç©º");
                    updateStatus('è¯·è¾“å…¥æœç´¢æ¡ä»¶');
                    return;
                }

                performSearch();
            });
        }

        // ç»‘å®šå›è½¦é”®æœç´¢
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    console.log('â†µ å›è½¦é”®è§¦å‘æœç´¢');
                    console.log('è¾“å…¥æ¡†å½“å‰å€¼:', this.value);
                    performSearch();
                }
            });
        }
    });
    function renderRoutes(routes) {
      const listContainer = document.getElementById('saved-routes');
      if (!listContainer) {
        console.error('âŒ ä¿å­˜è·¯çº¿å®¹å™¨ä¸å­˜åœ¨');
        return;
      }

      // æ¸…ç©ºç°æœ‰å†…å®¹
      listContainer.innerHTML = '';

      if (!routes || routes.length === 0) {
        // é‡ç”¨å·²æœ‰çš„ç©ºçŠ¶æ€æ˜¾ç¤ºé€»è¾‘
        displayNoResults();
        return;
      }

      // æ¸²æŸ“æ¯æ¡è·¯çº¿
      routes.forEach(route => {
        const item = document.createElement('div');
        item.className = 'route-item';
        item.setAttribute('data-id', route.id);
        item.onclick = () => loadSavedRoute(route.id);

        // âœ… ä¿®å¤ï¼šæ·»åŠ å®Œæ•´çš„æ“ä½œæŒ‰é’®ï¼ˆä¸æ­£å¸¸è·¯çº¿åˆ—è¡¨ä¸€è‡´ï¼‰
        item.innerHTML = `
          <div class="route-name">${route.name || 'æœªå‘½åè·¯çº¿'}</div>
          <div class="route-meta">
            <span><i class="fas fa-route"></i> ${route.distance ? route.distance.toFixed(1) : 0} km</span>
            <span><i class="fas fa-clock"></i> ${route.duration || 0} min</span>
            <span><i class="fas fa-tag"></i> ${route.route_type || 'æœªåˆ†ç±»'}</span>
          </div>
          <div class="route-detail">
            <span><i class="fas fa-map-marker"></i> ${route.district || 'æœªè®¾ç½®'}</span>

          </div>
          <div class="route-meta">
            <span><i class="fas fa-calendar"></i> ${new Date(route.created_at).toLocaleDateString()}</span>
            <span><i class="fas fa-user"></i> ${route.created_by || 'ç³»ç»Ÿ'}</span>
          </div>
          <!-- âœ… å…³é”®ä¿®å¤ï¼šæ·»åŠ æ“ä½œæŒ‰é’®éƒ¨åˆ† -->
          <div class="route-actions">
            <button class="route-action-btn edit-btn" onclick="event.stopPropagation(); editRoute(${route.id}, event)">
              <i class="fas fa-edit"></i> ç¼–è¾‘
            </button>
            <button class="route-action-btn delete-btn" onclick="event.stopPropagation(); deleteRoute(${route.id}, event)">
              <i class="fas fa-trash"></i> åˆ é™¤
            </button>
          </div>
        `;

        listContainer.appendChild(item);
      });
    }
    // ç™»å½•ç®¡ç†è„šæœ¬
    (function() {
        'use strict';

        // å…¨å±€å˜é‡
        window.ADMIN_TOKEN = null;
        window.IS_ADMIN = false;
        window.AUTH_ENABLED = true; // æ˜¯å¦å¯ç”¨è®¤è¯

        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        window.showLogin = function() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
        };

        // éšè—ç™»å½•å¼¹çª—
        window.hideLogin = function() {
            // å¦‚æœæœªç™»å½•ï¼Œä¸å…è®¸å…³é—­å¼¹çª—
            if (!window.ADMIN_TOKEN) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨ç³»ç»Ÿ');
                return;
            }
            document.getElementById('loginModal').style.display = 'none';
        };

        // å¤„ç†ç™»å½•
        window.handleLogin = async function(event) {
            if (event) event.preventDefault();

            const username = document.getElementById('modalUsername').value.trim();
            const password = document.getElementById('modalPassword').value;
            const loginBtn = document.getElementById('loginButton');
            const loading = document.getElementById('loginLoading');
            const errorDiv = document.getElementById('loginError');

            // æ˜¾ç¤ºåŠ è½½
            loginBtn.disabled = true;
            loginBtn.style.opacity = '0.7';
            loading.style.display = 'block';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.token) {
                    // ç™»å½•æˆåŠŸ
                    window.ADMIN_TOKEN = data.token;
                    window.IS_ADMIN = data.is_admin;

                    // ä¿å­˜åˆ° localStorage
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('isAdmin', data.is_admin);
                    localStorage.setItem('loginTime', new Date().toISOString());

                    console.log('âœ… ç™»å½•æˆåŠŸ');

                    // éšè—å¼¹çª—
                    document.getElementById('loginModal').style.display = 'none';

                    // æ˜¾ç¤ºç™»å½•çŠ¶æ€
                    document.getElementById('loginStatus').style.display = 'flex';

                    // è§¦å‘ç™»å½•æˆåŠŸäº‹ä»¶
                    window.dispatchEvent(new CustomEvent('loginSuccess', {
                        detail: { token: data.token, isAdmin: data.is_admin }
                    }));

                    // åˆ·æ–°é¡µé¢æ•°æ®
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    throw new Error(data.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ ç™»å½•å¤±è´¥:', error);
                errorDiv.textContent = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
                errorDiv.style.display = 'block';
            } finally {
                // æ¢å¤æŒ‰é’®
                loginBtn.disabled = false;
                loginBtn.style.opacity = '1';
                loading.style.display = 'none';
            }
        };

        // ç™»å‡º
        window.logout = function() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                window.ADMIN_TOKEN = null;
                window.IS_ADMIN = false;

                // æ¸…é™¤å­˜å‚¨
                localStorage.removeItem('adminToken');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('loginTime');

                // éšè—çŠ¶æ€æ¡
                document.getElementById('loginStatus').style.display = 'none';

                // æ˜¾ç¤ºç™»å½•å¼¹çª—
                showLogin();

                console.log('âœ… å·²é€€å‡ºç™»å½•');
            }
        };

        // è‡ªåŠ¨è®¤è¯çš„fetchå‡½æ•°
        window.authFetch = function(url, options = {}) {
            const token = window.ADMIN_TOKEN || localStorage.getItem('adminToken');

            if (!token && window.AUTH_ENABLED) {
                // æ˜¾ç¤ºç™»å½•å¼¹çª—
                showLogin();
                return Promise.reject('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
            }

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = 'Bearer ' + token;
            }

            return fetch(url, {
                ...options,
                headers: headers
            }).then(response => {
                if (response.status === 401) {
                    // tokenå¤±æ•ˆ
                    logout();
                    throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                }
                return response;
            });
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', function() {
            const token = localStorage.getItem('adminToken');
            const isAdmin = localStorage.getItem('isAdmin');

            if (token) {
                window.ADMIN_TOKEN = token;
                window.IS_ADMIN = isAdmin === '1';

                // æ˜¾ç¤ºç™»å½•çŠ¶æ€
                document.getElementById('loginStatus').style.display = 'flex';

                console.log('âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ');
            } else {
                // æ˜¾ç¤ºç™»å½•å¼¹çª—
                setTimeout(() => {
                    showLogin();
                }, 500);
            }

            // è¦†ç›–åŸç”Ÿfetchï¼Œè‡ªåŠ¨æ·»åŠ è®¤è¯
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const [url, options = {}] = args;

                // å¦‚æœæ˜¯ç™»å½•æ¥å£ï¼Œä¸æ·»åŠ è®¤è¯
                if (url.includes('/api/auth/login')) {
                    return originalFetch.apply(this, args);
                }

                const token = window.ADMIN_TOKEN || localStorage.getItem('adminToken');

                if (token && window.AUTH_ENABLED) {
                    options.headers = {
                        ...options.headers,
                        'Authorization': 'Bearer ' + token
                    };
                }

                return originalFetch.apply(this, [url, options]).then(response => {
                    if (response.status === 401 && window.AUTH_ENABLED) {
                        // tokenå¤±æ•ˆï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—
                        showLogin();
                        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    return response;
                });
            };
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆç”¨æˆ·åˆ‡å›æ ‡ç­¾é¡µæ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const token = localStorage.getItem('adminToken');
                if (!token && window.AUTH_ENABLED) {
                    showLogin();
                }
            }
        });

        // å¿«æ·é”®ï¼šCtrl+L æ˜¾ç¤ºç™»å½•å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                showLogin();
            }
        });
    })();
            // æ ‡è®°é¢æ¿æ˜¾ç¤ºçŠ¶æ€
    let markersPanelVisible = true;

    // åˆ‡æ¢æ ‡è®°é¢æ¿æ˜¾ç¤º/éšè—
    function toggleMarkersPanel() {
        const markersPanel = document.querySelector('.markers-panel');
        const toggleBtn = document.getElementById('toggle-markers-panel');
        const mapContainer = document.getElementById('map-container');

        markersPanelVisible = !markersPanelVisible;

        if (markersPanelVisible) {
            // æ˜¾ç¤ºé¢æ¿
            markersPanel.classList.remove('hidden');
            toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            toggleBtn.title = 'éšè—é¢æ¿';
        } else {
            // éšè—é¢æ¿
            markersPanel.classList.add('hidden');
            toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            toggleBtn.title = 'æ˜¾ç¤ºé¢æ¿';
        }

        // è°ƒæ•´åœ°å›¾å¤§å°
        setTimeout(() => {
            if (window.map) {
                window.map.resize();
            }
        }, 300);

        // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('markersPanelVisible', markersPanelVisible);
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é¢æ¿çŠ¶æ€
    function initMarkersPanelState() {
        const savedState = localStorage.getItem('markersPanelVisible');
        if (savedState !== null) {
            markersPanelVisible = savedState === 'true';
            if (!markersPanelVisible) {
                toggleMarkersPanel(); // åº”ç”¨ä¿å­˜çš„çŠ¶æ€
            }
        }
    }

    // åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨
    window.addEventListener('load', function() {
        initMarkersPanelState();
    });
    </script>
</body>
</html>